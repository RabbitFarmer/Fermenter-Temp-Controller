<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Batch Settings</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .selector-wrap { max-width:1000px; margin:18px auto; padding:18px; background:#fff; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    .heading { font-weight:900; margin-bottom:12px; }
    .tilt-grid { display:flex; gap:12px; flex-wrap:wrap; }
    .tilt-tile { width:220px; border-radius:8px; padding:12px; background:#f6f6f6; text-align:center; cursor:pointer; text-decoration:none; color:inherit; box-shadow:0 1px 4px rgba(0,0,0,0.04); }
    .tilt-tile .title { font-weight:900; margin-bottom:6px; }
    .tilt-tile .meta { font-size:13px; color:#444; }
    .all-colors { margin-top:14px; display:none; }
    .color-list { display:flex; flex-wrap:wrap; gap:8px; }
    .color-pill { padding:8px 10px; border-radius:6px; background:#e9eef0; cursor:pointer; text-decoration:none; color:#000; font-weight:700; }
    .toggle-btn { display:inline-block; margin-top:12px; padding:8px 12px; border-radius:6px; background:#0b8a2e; color:#fff; text-decoration:none; font-weight:800; }
    .note { color:#666; font-size:0.95em; margin-top:8px; }
    .form-row { display:flex; gap:8px; }
    .form-col { flex:1; }
    label { display:block; margin-bottom:6px; font-weight:700; }
    input[type="text"], input[type="number"], input[type="date"] { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .small-note { font-size:0.9em; color:#555; margin-top:6px; }
    .muted { color:#777; font-size:0.9em; }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="site-header">
      <nav class="config-ribbon" role="navigation">
        <a href="/">Return to Dashboard</a>
      </nav>
      <h1 class="dashboard-title">BATCH SETTINGS</h1>
    </header>

    <div class="selector-wrap">
      <div class="heading">Active Tilts</div>

      {% if active_colors %}
        <div class="tilt-grid">
          {% for color in active_colors %}
            {% set t = live_tilts.get(color, {}) %}
            {% set border_color = color_map.get(color, '#cccccc') %}
            <a class="tilt-tile" href="{{ url_for('batch_settings') }}?tilt_color={{ color|urlencode }}" style="border: 3px solid {{ border_color }};">
              <div class="title">{{ t.beer_name or 'Unnamed Beer' }}</div>
              <div class="meta">Tilt: <strong>{{ color }}</strong></div>
              <div class="meta">Batch: {{ t.batch_name or '--' }}</div>
              <div class="meta">Temp: {{ t.temp_f or '--' }}°F</div>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="note">No active tilts currently reporting. Use the "Show all colors" button to configure a tilt manually.</div>
      {% endif %}

      <div style="margin-top:18px;">
        <a id="toggle-all-colors" class="toggle-btn" href="#" role="button">Show all colors</a>
      </div>

      <div id="all-colors" class="all-colors" aria-hidden="true">
        <div class="heading" style="margin-top:12px;">All known Tilt Colors</div>
        <div class="color-list">
          {% for color in tilt_colors %}
            <a class="color-pill" href="{{ url_for('batch_settings') }}?tilt_color={{ color|urlencode }}">{{ color }}</a>
          {% endfor %}
        </div>
        <div class="note">Pick any color to configure that Tilt (even if it's not reporting right now).</div>
      </div>
    </div>

    {% if selected_tilt %}
      <div class="selector-wrap" style="margin-top:16px;">
        <div class="heading">Editing: {{ selected_tilt }}</div>
        <form method="post" action="/batch_settings">
          <input type="hidden" name="tilt_color" value="{{ selected_tilt }}">

          <div style="margin-bottom:8px;">
            <label>Beer Name</label>
            <input name="beer_name" value="{{ selected_config.beer_name or '' }}" style="width:100%;padding:8px;">
          </div>

          <div style="margin-bottom:8px;">
            <label>Batch Name</label>
            <input name="batch_name" value="{{ selected_config.batch_name or '' }}" style="width:100%;padding:8px;">
          </div>

          <div class="form-row" style="margin-bottom:8px;">
            <div class="form-col">
              <label>Ferm Start Date</label>
              <input type="date" name="ferm_start_date" value="{{ selected_config.ferm_start_date or '' }}">
            </div>
            <div class="form-col">
              <label>Estimated ABV (Recipe)</label>
              <input type="number" step="0.1" min="0" name="recipe_abv" value="{{ selected_config.recipe_abv if selected_config.recipe_abv is not none else '' }}" placeholder="e.g. 5.2">
            </div>
          </div>

          <!-- New: Recipe details block (recipe OG/FG) -->
          <div style="margin-top:10px; padding:12px; background:#f9fbf9; border-radius:8px; border:1px solid #eef6ea;">
            <div class="heading" style="font-size:1em; margin-bottom:8px;">Recipe Details</div>

            <div class="form-row" style="margin-bottom:8px;">
              <div class="form-col">
                <label>Recipe Original Gravity (OG)</label>
                <input type="number" step="0.001" min="0" name="recipe_og" value="{{ selected_config.recipe_og if selected_config.recipe_og is not none else '' }}" placeholder="e.g. 1.050">
              </div>
              <div class="form-col">
                <label>Recipe Final Gravity (FG)</label>
                <input type="number" step="0.001" min="0" name="recipe_fg" value="{{ selected_config.recipe_fg if selected_config.recipe_fg is not none else '' }}" placeholder="e.g. 1.012">
              </div>
            </div>

            <div class="small-note muted">Providing the recipe OG/FG and estimated ABV allows the dashboard to show both recipe expectations and actual fermentation progress in the Tilt cards.</div>
          </div>

          <!-- New: Original Gravity confirmation input -->
          <div style="margin-top:12px; padding:12px; border-radius:8px; background:#fff8f8; border:1px solid #f4e1e1;">
            <div class="heading" style="font-size:1em; margin-bottom:8px;">Original Gravity Confirmation</div>

            <div class="form-row" style="margin-bottom:8px;">
              <div class="form-col">
                <label>Measured Original Gravity (from Tilt / hydrometer)</label>
                <input type="number" step="0.001" min="0" name="actual_og" value="{{ selected_config.actual_og if selected_config.actual_og is not none else '' }}" placeholder="e.g. 1.050">
              </div>
              <div class="form-col" style="align-self:flex-end;">
                <label style="font-weight:700;">Confirm OG</label>
                <div>
                  <label style="font-weight:600;"><input type="checkbox" name="og_confirmed" value="1" {% if selected_config.og_confirmed %}checked{% endif %}> I confirm the original gravity reading is correct</label>
                </div>
              </div>
            </div>

            <div class="small-note muted">If you confirm an actual measured OG, the dashboard will use that value when calculating live ABV for this batch.</div>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px;">
            <button type="submit">Save Batch</button>
            <a href="/batch_settings" style="align-self:center; margin-left:8px; text-decoration:none;">Back to selection</a>
          </div>
        </form>

        {% if batch_history %}
          <div style="margin-top:12px;">
            <div class="heading">Batch History</div>
            <ul>
              {% for b in batch_history %}
                <li>{{ b.ferm_start_date }} — {{ b.beer_name }} / {{ b.batch_name }} (OG: {{ b.recipe_og or b.actual_og or '--' }})</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    (function(){
      const toggle = document.getElementById('toggle-all-colors');
      const panel = document.getElementById('all-colors');
      if(toggle && panel){
        toggle.addEventListener('click', function(ev){
          ev.preventDefault();
          const shown = panel.getAttribute('aria-hidden') === 'false';
          panel.style.display = shown ? 'none' : 'block';
          panel.setAttribute('aria-hidden', shown ? 'true' : 'false');
          toggle.textContent = shown ? 'Show all colors' : 'Hide all colors';
        });
      }
    })();
  </script>
</body>
</html>