<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ system_settings.brewery_name }} - Fermentation Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css">
  <style>
    .tilt-batch-name {
      font-size: 0.95em;
      font-style: italic;
      font-weight: bold;
      margin-bottom: 2px;
      text-align: center;
    }
    .tilt-color-label {
      font-size: 0.85em;
      text-align: left;
      margin-left: 12px;
      margin-bottom: 2px;
    }
    .tilt-footer-colored {
      padding: 8px;
      color: inherit;
      font-size: 0.9em;
    }
  </style>
  {% if refresh %}
    <script>
      // Only reload once, strip ?refresh=1 after reload
      if (window.location.search.includes('refresh=1')) {
        window.location.replace(window.location.pathname);
      }
    </script>
  {% endif %}
</head>
<body>

  <div class="config-ribbon">
    <a href="/system_config">System Settings</a>
    <a href="/temp_config">Temperature Control</a>
    <a href="/tilt_config">Batch Settings</a>
  </div>

  <div class="dashboard-title">{{ system_settings.brewery_name }}</div>

  <div class="tiltcard-container">
    {% for color, tilt in tilts.items() %}
      <div class="tilt-card">
        <!-- Banner/Header: Beer Name and Batch Name -->
        <div class="tilt-banner"
             style="background-color: {{ tilt.color_code }};
                    text-align: center;
                    color: {% if tilt.color_code == '#ffff00' or tilt.color_code == '#ffc0cb' or tilt.color_code == '#00ff00' %}black{% else %}white{% endif %};">
          <div style="font-size: 1.3em; font-weight: bold;">
            {{ tilt.beer_name or 'Unnamed Beer' }}
          </div>
          <div class="tilt-batch-name">
            Batch: {{ tilt.batch_name or 'Unnamed Batch' }}
          </div>
        </div>
        <!-- Tilt color label below banner -->
        <div class="tilt-color-label" style="font-size: 0.85em; text-align: left; margin-left: 12px; margin-bottom: 6px;">
          {{ color }} Tilt
        </div>

        <!-- Matrix Table -->
        <table class="tilt-metrics">
          <tr>
            <th style="width:43%"></th>
            <th class="right-header" style="width:30%">Recipe</th>
            <th class="right-header" style="width:30%">Actual</th>
          </tr>
          <tr>
            <td class="label">Original Gravity</td>
            <td class="value">{{ "%.3f"|format(tilt.recipe_og|default(0)|float) }}</td>
            <td class="value"><b>{{ "%.3f"|format(tilt.original_gravity|default(0)|float) }}</b></td>
          </tr>
          <tr>
            <td class="label">Final / Current Gravity</td>
            <td class="value">{{ "%.3f"|format(tilt.recipe_fg|default(0)|float) }}</td>
            <td class="value"><b>{{ "%.3f"|format(tilt.gravity|default(0)|float) }}</b></td>
          </tr>
          <tr>
            <td class="label">Temperature</td>
            <td class="value"></td>
            <td class="value"><b>{{ "%.1f"|format(tilt.temp_f|default(0)|float) }}Â°F</b></td>
          </tr>
          <tr>
            <td class="label">A.B.V.</td>
            <td class="value">
              {% if tilt.recipe_abv %}
                {{ "%.1f"|format(tilt.recipe_abv|float) }}%
              {% else %}
                --
              {% endif %}
            </td>
            <td class="value"><b>
              {% if tilt.actual_og and tilt.gravity %}
                {{ ((tilt.actual_og|float - tilt.gravity|float) * 131.25)|round(1) }}%
              {% else %}
                --
              {% endif %}
            </b></td>
          </tr>
        </table>
        <!-- Footer Info: Brew ID, Last Reading, Chart Button. All on colored background -->
        <div class="tilt-footer-colored"
             style="background: {{ tilt.color_code }};
                    color: {% if tilt.color_code == '#ffff00' or tilt.color_code == '#ffc0cb' or tilt.color_code == '#00ff00' %}black{% else %}white{% endif %};">
          <div class="footer-row">
            <div class="footer-item">Brew ID: {{ tilt.brewid or '--' }}</div>
          </div>
          <div class="footer-row">
            <div class="footer-item" style="display:inline-block;">Last Reading: {{ tilt.timestamp | localtime }}</div>
            <div class="footer-chart" style="float:right;">
              <form action="/chart/{{ color }}" method="get" style="display:inline;">
                <button type="submit" class="btn-chart-footer">Chart</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- FULL TEMPERATURE CONTROL SECTION (restored) -->
  <div class="temp-control-ribbon">
    <div class="temp-header">
      <div class="temp-title">FERMENTER TEMPERATURE CONTROL</div>
      <div class="temp-subtitle">Monitored by {{ temp_control.tilt_color }} Tilt</div>
    </div>

    <!-- Matrix Table for Temperature Control -->
    <table class="temp-matrix" style="table-layout: fixed; width: 75%;">
      <tr>
        <td style="vertical-align: bottom; text-align: center;"><b>Mode</b></td>
        <td style="text-align: center;">
          {% if temp_control.heating_error %}
            <span class="heat-on" style="color:#c00;background:#ffdada;">HEATING ERROR</span>
          {% elif temp_control.heater_on %}
            <span class="heat-on" style="background:#ffdada;">HEATING ON</span>
          {% else %}
            <!-- blank -->
          {% endif %}
        </td>
        <td style="vertical-align: bottom; text-align: center;"><b>Status</b></td>
      </tr>
      <tr>
        <td style="text-align: center;">
          <!-- Mode Statement -->
          {% if temp_control.override_mode %}
            <span class="status-override">Manual Override</span>
          {% elif temp_control.enable_heating and temp_control.enable_cooling %}
            <span class="status-both">Heating &amp; Cooling</span>
          {% elif temp_control.enable_heating %}
            <span class="status-heating">Heating Selected</span>
          {% elif temp_control.enable_cooling %}
            <span class="status-cooling">Cooling Selected</span>
          {% elif temp_control.tilt_color in live_tilts %}
            Monitoring Only
          {% else %}
            <span class="status-off">OFF</span>
          {% endif %}
        </td>
        <td style="text-align: center;">
          {% if temp_control.cooling_error %}
            <span class="cooling-on" style="color:#007bff;background:#e0f7ff;">COOLING ERROR</span>
          {% elif temp_control.cooler_on %}
            <span class="cooling-on" style="background:#e0f7ff;">COOLING ON</span>
          {% else %}
            <!-- blank -->
          {% endif %}
        </td>
        <td style="text-align: center;">
          {% if temp_control.current_temp is not none and temp_control.high_limit is not none and temp_control.current_temp > temp_control.high_limit %}
            <span class="status-outofrange">Above High Limit</span>
          {% elif temp_control.current_temp is not none and temp_control.low_limit is not none and temp_control.current_temp < temp_control.low_limit %}
            <span class="status-outofrange">Below Low Limit</span>
          {% elif temp_control.heating_error %}
            Heating Error
          {% elif temp_control.cooling_error %}
            Cooling Error
          {% elif temp_control.heater_on %}
            Heating
          {% elif temp_control.cooler_on %}
            Cooling
          {% elif temp_control.current_temp is not none and temp_control.low_limit is not none and temp_control.high_limit is not none and temp_control.current_temp >= temp_control.low_limit and temp_control.current_temp <= temp_control.high_limit %}
            <span class="status-inrange">In Range</span>
          {% else %}
            Unknown
          {% endif %}
        </td>
      </tr>
      <tr>
        <td style="vertical-align: bottom; text-align: center;"><b>Low Limit</b></td>
        <td style="vertical-align: bottom; text-align: center;"><b>Current Temp</b></td>
        <td style="vertical-align: bottom; text-align: center;"><b>High Limit</b></td>
      </tr>
      <tr>
        <td style="text-align: center;">
          {% if temp_control.enable_heating or temp_control.enable_cooling %}
            {{ temp_control.low_limit or '--' }}
          {% else %}
            --
          {% endif %}
        </td>
        <td style="text-align: center;">
          {{ temp_control.current_temp or '--' }}
        </td>
        <td style="text-align: center;">
          {% if temp_control.enable_heating or temp_control.enable_cooling %}
            {{ temp_control.high_limit or '--' }}
          {% else %}
            --
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
</body>
</html>