<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ metadata.beer_name }} - Batch Details</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    .page { max-width: 1400px; margin:20px auto; padding:18px; background:#fff; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .metadata-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .metadata-card { background: #f6f9f6; padding: 16px; border-radius: 8px; border-left: 4px solid #0b8a2e; }
    .metadata-label { font-weight: 700; color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 4px; }
    .metadata-value { font-size: 18px; font-weight: 600; color: #222; }
    .chart-container { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    #chart { width: 100%; height: 600px; }
    .stats-row { display: flex; gap: 16px; margin-top: 20px; }
    .stat-box { flex: 1; background: #fff; border: 2px solid #0b8a2e; border-radius: 8px; padding: 12px; text-align: center; }
    .stat-label { font-size: 12px; font-weight: 700; color: #666; text-transform: uppercase; }
    .stat-value { font-size: 24px; font-weight: 900; color: #0b8a2e; margin-top: 4px; }
    .back-button { display: inline-block; padding: 10px 16px; background: #0b8a2e; color: white; text-decoration: none; border-radius: 6px; font-weight: 700; }
    .back-button:hover { background: #096b24; }
    @media (max-width: 768px) {
      #chart { height: 400px; }
      .stats-row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="site-header">
      <nav class="config-ribbon">
        <a href="/">Dashboard</a>
        <a href="/batch_history">Batch History</a>
        <a href="/tilt_config">Tilt Configuration</a>
      </nav>
      <h1 class="dashboard-title">Batch Details: {{ metadata.beer_name }}</h1>
    </header>

    <main class="page" role="main">
      <div class="header">
        <div>
          <h2 style="margin:0;">{{ metadata.beer_name }}</h2>
          <p style="color:#666; margin:4px 0 0 0;">{{ metadata.batch_name }}</p>
        </div>
        <a href="/batch_history" class="back-button">← Back to History</a>
      </div>

      <div class="metadata-grid">
        <div class="metadata-card">
          <div class="metadata-label">Brew ID</div>
          <div class="metadata-value">{{ metadata.brewid }}</div>
        </div>
        <div class="metadata-card">
          <div class="metadata-label">Tilt Color</div>
          <div class="metadata-value">{{ metadata.tilt_color }}</div>
        </div>
        <div class="metadata-card">
          <div class="metadata-label">Start Date</div>
          <div class="metadata-value">{{ metadata.created_date }}</div>
        </div>
        <div class="metadata-card">
          <div class="metadata-label">Total Samples</div>
          <div class="metadata-value">{{ samples|length }}</div>
        </div>
      </div>

      {% if samples %}
        <div class="chart-container">
          <h3 style="margin-top:0;">Fermentation Chart</h3>
          <div id="chart"></div>
        </div>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-label">Starting Gravity</div>
            <div class="stat-value" id="og">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Final Gravity</div>
            <div class="stat-value" id="fg">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Estimated ABV</div>
            <div class="stat-value" id="abv">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Duration</div>
            <div class="stat-value" id="duration">--</div>
          </div>
        </div>

        <script>
          // Batch data from server
          const samples = {{ samples|tojson }};
          
          if (samples && samples.length > 0) {
            // Extract data for plotting
            const timestamps = samples.map(s => s.timestamp);
            const temps = samples.map(s => s.temp_f);
            const gravities = samples.map(s => s.gravity);
            
            // Temperature trace
            const tempTrace = {
              x: timestamps,
              y: temps,
              mode: 'lines+markers',
              name: 'Temperature (°F)',
              line: { color: '#e04b4b', width: 2 },
              marker: { size: 4 },
              yaxis: 'y1',
            };
            
            // Gravity trace
            const gravityTrace = {
              x: timestamps,
              y: gravities,
              mode: 'lines+markers',
              name: 'Gravity',
              line: { color: '#E69D00', width: 2 },
              marker: { size: 4 },
              yaxis: 'y2',
            };
            
            // Calculate dynamic gravity range with padding
            const validGravities = gravities.filter(g => g && g > 0);
            let gravityRange = [0.990, 1.100]; // Default range
            if (validGravities.length > 0) {
              const minGrav = Math.min(...validGravities);
              const maxGrav = Math.max(...validGravities);
              const padding = (maxGrav - minGrav) * 0.1 || 0.010; // 10% padding or minimum 0.010
              gravityRange = [
                Math.max(0.990, minGrav - padding),
                Math.min(1.150, maxGrav + padding)
              ];
            }
            
            const layout = {
              title: {
                text: '{{ metadata.beer_name }} - Fermentation Progress',
                font: { size: 18 },
              },
              xaxis: {
                title: 'Date/Time',
                gridcolor: '#eaf2f5',
              },
              yaxis: {
                title: 'Temperature (°F)',
                titlefont: { color: '#e04b4b' },
                tickfont: { color: '#e04b4b' },
                gridcolor: '#eaf2f5',
              },
              yaxis2: {
                title: 'Gravity',
                titlefont: { color: '#E69D00' },
                tickfont: { color: '#E69D00' },
                overlaying: 'y',
                side: 'right',
                range: gravityRange,
              },
              showlegend: true,
              legend: { 
                orientation: 'h', 
                x: 0.5, 
                xanchor: 'center', 
                y: -0.15 
              },
              margin: { l: 60, r: 60, t: 60, b: 80 },
            };
            
            Plotly.newPlot('chart', [tempTrace, gravityTrace], layout, {responsive: true});
            
            // Calculate statistics
            const validGravities = gravities.filter(g => g && g > 0);
            if (validGravities.length > 0) {
              const og = validGravities[0];
              const fg = validGravities[validGravities.length - 1];
              
              // ABV calculation using standard formula: (OG - FG) * 131.25
              // This is a widely-used approximation for alcohol by volume percentage
              const ABV_CONVERSION_FACTOR = 131.25;
              const abv = ((og - fg) * ABV_CONVERSION_FACTOR).toFixed(1);
              
              document.getElementById('og').textContent = og.toFixed(3);
              document.getElementById('fg').textContent = fg.toFixed(3);
              document.getElementById('abv').textContent = abv + '%';
            }
            
            // Calculate duration
            if (timestamps.length > 1) {
              const start = new Date(timestamps[0]);
              const end = new Date(timestamps[timestamps.length - 1]);
              const diffMs = end - start;
              const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
              const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
              
              if (diffDays > 0) {
                document.getElementById('duration').textContent = diffDays + 'd ' + diffHours + 'h';
              } else {
                document.getElementById('duration').textContent = diffHours + ' hours';
              }
            }
          }
        </script>
      {% else %}
        <div style="text-align:center; padding:40px; color:#666;">
          <p>No sample data found for this batch.</p>
        </div>
      {% endif %}
    </main>
  </div>
</body>
</html>
