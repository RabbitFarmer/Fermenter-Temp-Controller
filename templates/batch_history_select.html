<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Batch History</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .history-container { max-width:1200px; margin:18px auto; padding:18px; background:#fff; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.04); }
    .heading { font-weight:900; margin-bottom:16px; font-size:1.5em; color:#1a6; }
    .section-heading { font-weight:800; margin-top:24px; margin-bottom:12px; font-size:1.3em; color:#333; padding-bottom:8px; border-bottom:2px solid #1a6; }
    .batch-list { list-style:none; padding:0; }
    .batch-item { padding:12px; margin:8px 0; background:#f9f9f9; border-radius:6px; border-left:4px solid #1a6; display:flex; justify-content:space-between; align-items:center; }
    .batch-item:hover { background:#f0f0f0; }
    .batch-link { text-decoration:none; color:#333; flex:1; }
    .batch-name { font-weight:700; font-size:1.1em; margin-bottom:4px; }
    .batch-details { font-size:0.9em; color:#666; }
    .btn-view-chart { padding:8px 16px; background-color:#4CAF50; color:white; border:none; cursor:pointer; font-size:14px; font-weight:bold; border-radius:5px; text-decoration:none; display:inline-block; margin-left:10px; }
    .btn-view-chart:hover { background-color:#45a049; }
    .no-history { color:#999; font-style:italic; padding:20px; text-align:center; }
    .btn-action { padding:10px 20px; background-color:#8B4513; color:white; border:none; cursor:pointer; font-size:16px; font-weight:bold; border-radius:5px; text-decoration:none; display:inline-block; margin-right:10px; }
    .controls { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px; }
    .sort-control { display:flex; align-items:center; gap:8px; }
    .sort-label { font-weight:700; font-size:14px; color:#333; }
    .sort-select { 
      padding:8px 12px; 
      font-size:14px; 
      font-weight:600;
      border:2px solid #4CAF50; 
      border-radius:5px; 
      background-color:#fff; 
      color:#333;
      cursor:pointer;
      min-width:200px;
    }
    .sort-select:hover { background-color:#f0f0f0; }
    .sort-select:focus { outline:none; border-color:#45a049; }
    .archive-note { background:#f9f9f9; padding:12px; border-radius:6px; margin-top:20px; font-size:0.9em; color:#666; }
    .archive-note strong { color:#333; }
  </style>
  <script>
    function changeSortOrder() {
      const select = document.getElementById('sortSelect');
      const sortValue = select.value;
      window.location.href = '{{ url_for("batch_history") }}?sort=' + sortValue;
    }
    
    function closeBatch(brewid, color) {
      if (!confirm('Close this batch? It will move to Batch History section.')) {
        return;
      }
      
      fetch('/close_batch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'brewid=' + encodeURIComponent(brewid) + '&color=' + encodeURIComponent(color)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Error closing batch: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('Error closing batch: ' + error);
      });
    }
    
    function reopenBatch(brewid, color) {
      if (!confirm('Reopen this batch? It will move to Current Activity section.')) {
        return;
      }
      
      fetch('/reopen_batch', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'brewid=' + encodeURIComponent(brewid) + '&color=' + encodeURIComponent(color)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.reload();
        } else {
          alert('Error reopening batch: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        alert('Error reopening batch: ' + error);
      });
    }
  </script>
</head>
<body>
  <div class="page-container">
    <header class="site-header">
      <h1 class="dashboard-title">BATCH HISTORY</h1>
    </header>

    <div class="history-container">
      <div class="controls">
        <button type="button" onclick="window.location='/'" class="btn-action">Dashboard</button>
        <div class="sort-control">
          <label for="sortSelect" class="sort-label">ðŸ“… Sort by:</label>
          <select id="sortSelect" class="sort-select" onchange="changeSortOrder()">
            <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Date: Newest First</option>
            <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Date: Oldest First</option>
            <option value="beer_name" {% if sort_order == 'beer_name' %}selected{% endif %}>Beer Name (A-Z)</option>
            <option value="color" {% if sort_order == 'color' %}selected{% endif %}>Tilt Color (A-Z)</option>
          </select>
        </div>
      </div>

      <!-- Current Activity Section -->
      <div class="section-heading">ðŸ”¬ Current Activity</div>
      {% if active_batches %}
        <ul class="batch-list">
          {% for batch in active_batches %}
            <li class="batch-item">
              <a href="{{ url_for('batch_review', brewid=batch.brewid) }}" class="batch-link">
                <div class="batch-name">
                  <span class="tilt-color-badge" style="background-color: {{ color_map.get(batch.color, '#e9eef0') }}; {% if batch.color in ['Black', 'Purple', 'Blue', 'Green', 'Red'] %}color: #fff;{% endif %}">{{ batch.color }}</span>
                  {{ batch.beer_name or 'Unnamed Beer' }} - {{ batch.batch_name or 'Batch' }}
                </div>
                <div class="batch-details">
                  Started: {{ batch.ferm_start_date or 'Unknown' }} â€¢ 
                  Brew ID: {{ batch.brewid[:8] if batch.brewid else 'N/A' }} â€¢ 
                  {% if batch.actual_og %}OG: {{ batch.actual_og }}{% elif batch.recipe_og %}Recipe OG: {{ batch.recipe_og }}{% endif %}
                </div>
              </a>
              <div class="batch-actions">
                <button type="button" class="btn-close" onclick="closeBatch('{{ batch.brewid }}', '{{ batch.color }}'); event.stopPropagation();">Close</button>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="no-history">
          No active batches. Start a new batch from the dashboard to begin tracking fermentation.
        </div>
      {% endif %}

      <!-- Batch History Section -->
      <div class="section-heading">ðŸ“š Batch History (Closed)</div>
      {% if closed_batches %}
        <ul class="batch-list">
          {% for batch in closed_batches %}
            <li class="batch-item">
              <a href="{{ url_for('batch_review', brewid=batch.brewid) }}" class="batch-link">
                <div class="batch-name">
                  <span class="tilt-color-badge" style="background-color: {{ color_map.get(batch.color, '#e9eef0') }}; {% if batch.color in ['Black', 'Purple', 'Blue', 'Green', 'Red'] %}color: #fff;{% endif %}">{{ batch.color }}</span>
                  {{ batch.beer_name or 'Unnamed Beer' }} - {{ batch.batch_name or 'Batch' }}
                </div>
                <div class="batch-details">
                  Started: {{ batch.ferm_start_date or 'Unknown' }} â€¢ 
                  {% if batch.closed_date %}Closed: {{ batch.closed_date }} â€¢ {% endif %}
                  Brew ID: {{ batch.brewid[:8] if batch.brewid else 'N/A' }} â€¢ 
                  {% if batch.actual_og %}OG: {{ batch.actual_og }}{% elif batch.recipe_og %}Recipe OG: {{ batch.recipe_og }}{% endif %}
                </div>
              </a>
              <div class="batch-actions">
                <button type="button" class="btn-reopen" onclick="reopenBatch('{{ batch.brewid }}', '{{ batch.color }}'); event.stopPropagation();">Reopen</button>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        {% for color_data in colors_with_history %}
          <div class="color-section">
            <div class="color-header" style="background-color: {{ color_map.get(color_data.color, '#e9eef0') }}; {% if color_data.color in ['Black', 'Purple', 'Blue', 'Green', 'Red'] %}color: #fff;{% endif %}">
              {{ color_data.color }} Tilt ({{ color_data.count }} batch{{ 'es' if color_data.count != 1 else '' }})
            </div>
            
            <ul class="batch-list">
              {% for batch in color_data.batches %}
                <li class="batch-item">
                  <a href="{{ url_for('batch_review', brewid=batch.brewid) }}" class="batch-link">
                    <div class="batch-name">{{ batch.beer_name or 'Unnamed Beer' }} - {{ batch.batch_name or 'Batch' }}</div>
                    <div class="batch-details">
                      Started: {{ batch.ferm_start_date or 'Unknown' }} â€¢ 
                      Brew ID: {{ batch.brewid[:8] if batch.brewid else 'N/A' }} â€¢ 
                      {% if batch.actual_og %}OG: {{ batch.actual_og }}{% elif batch.recipe_og %}Recipe OG: {{ batch.recipe_og }}{% endif %}
                    </div>
                  </a>
                  <a href="{{ url_for('chart_plotly_for', tilt_color=color_data.color) }}" class="btn-view-chart">View Chart</a>
                </li>
              {% endfor %}
            </ul>
          </div>
        {% endfor %}
      {% endif %}

      <!-- Archive Information -->
      <div class="archive-note">
        <strong>ðŸ“¦ Archive Location:</strong> When you archive batch data files, they are moved to the <code>batches/archive/</code> directory with a timestamp. Archived files preserve all fermentation data but are removed from active tracking.
      </div>
    </div>
  </div>
</body>
</html>
