<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>System Settings</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* small spacing tweaks to match your UI */
    .config-table input[type="text"], .config-table input[type="email"], .config-table input[type="number"], .config-table input[type="password"], .config-table select, .config-table textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
    }
    .config-table td { vertical-align: top; padding: 6px 8px; }
    
    /* Tab navigation styles */
    .tab-navigation {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 800px;
    }
    
    .tab-button {
      padding: 12px 24px;
      background-color: #8B4513;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      transition: background-color 0.3s;
    }
    
    .tab-button:hover {
      background-color: #A0522D;
    }
    
    .tab-button.active {
      background-color: #654321;
      border-bottom: 3px solid #FFA500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body class="page-bg">
  <div class="temp-config-setup-ribbon">
    <div class="temp-header">
      <div class="temp-title">SYSTEM SETTINGS CONFIGURATION</div>
      <div class="temp-subtitle">Edit global system configuration</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button type="button" class="tab-button active" onclick="openTab(event, 'main-settings')">Main Settings</button>
      <button type="button" class="tab-button" onclick="openTab(event, 'sms-email')">SMS/eMail</button>
      <button type="button" class="tab-button" onclick="openTab(event, 'logging-integrations')">Logging Integrations</button>
      <button type="button" class="tab-button" onclick="openTab(event, 'backup-restore')">Backup/Restore</button>
    </div>

    <form action="{{ url_for('update_system_config') }}" method="post" class="temp-config-form">
      
      <!-- Main Settings Tab -->
      <div id="main-settings" class="tab-content active">
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td><label for="brewery_name"><b>Brewery Name</b></label></td>
            <td><input type="text" name="brewery_name" id="brewery_name" value="{{ system_settings.get('brewery_name','') }}"></td>
          </tr>
          <tr>
            <td><label for="brewer_name"><b>Brewer Name</b></label></td>
            <td><input type="text" name="brewer_name" id="brewer_name" value="{{ system_settings.get('brewer_name','') }}"></td>
          </tr>
          <tr>
            <td><label for="street"><b>Street Address</b></label></td>
            <td><input type="text" name="street" id="street" value="{{ system_settings.get('street','') }}"></td>
          </tr>
          <tr>
            <td><label for="city"><b>City</b></label></td>
            <td><input type="text" name="city" id="city" value="{{ system_settings.get('city','') }}"></td>
          </tr>
          <tr>
            <td><label for="state"><b>State</b></label></td>
            <td><input type="text" name="state" id="state" value="{{ system_settings.get('state','') }}"></td>
          </tr>
          <tr>
            <td><label for="timezone"><b>Time Zone</b></label></td>
            <td><input type="text" name="timezone" id="timezone" value="{{ system_settings.get('timezone','') }}"></td>
          </tr>
          <tr>
            <td><label for="timestamp_format"><b>Timestamp Format</b></label></td>
            <td><input type="text" name="timestamp_format" id="timestamp_format" value="{{ system_settings.get('timestamp_format','') }}"></td>
          </tr>
          <tr>
            <td><label for="update_interval"><b>Update Interval (minutes between control loop checks)</b></label></td>
            <td><input type="number" name="update_interval" id="update_interval" value="{{ system_settings.get('update_interval','1') }}"></td>
          </tr>
          <tr>
            <td><label for="tilt_reading_interval"><b>Tilt Reading Logging Interval (minutes)</b></label></td>
            <td><input type="number" name="tilt_reading_interval" id="tilt_reading_interval" value="{{ system_settings.get('tilt_reading_interval','') }}"></td>
          </tr>
          <tr>
            <td><label for="temp_logging_interval"><b>Temperature Control Logging Interval (minutes)</b></label></td>
            <td><input type="number" name="temp_logging_interval" id="temp_logging_interval" value="{{ system_settings.get('temp_logging_interval','') }}"></td>
          </tr>

          <tr>
            <td><label for="kasa_rate_limit_seconds"><b>Kasa Rate Limit (seconds)</b></label></td>
            <td><input type="number" name="kasa_rate_limit_seconds" id="kasa_rate_limit_seconds" value="{{ system_settings.get('kasa_rate_limit_seconds', 10) }}"></td>
          </tr>
        </table>

        <div style="text-align:center; margin-top:20px;">
          <button type="submit" class="btn-primary">Save System Settings</button>
          <button type="button" onclick="window.location='/'" class="btn-secondary" style="margin-left:16px;">Cancel Changes</button>
        </div>
      </div>

      <!-- SMS/eMail Tab -->
      <div id="sms-email" class="tab-content">
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td><label for="sending_email"><b>Sending Email Address</b></label></td>
            <td><input type="email" name="sending_email" id="sending_email" value="{{ system_settings.get('sending_email','') }}"></td>
          </tr>
          <tr>
            <td><label for="sending_email_password"><b>Sending Email Password</b></label></td>
            <td><input type="password" name="sending_email_password" id="sending_email_password" placeholder="Enter password"></td>
          </tr>
          <tr>
            <td><label for="smtp_host"><b>SMTP Server Host</b></label></td>
            <td><input type="text" name="smtp_host" id="smtp_host" value="{{ system_settings.get('smtp_host', 'smtp.gmail.com') }}" placeholder="e.g., smtp.gmail.com"></td>
          </tr>
          <tr>
            <td><label for="smtp_port"><b>SMTP Server Port</b></label></td>
            <td><input type="number" name="smtp_port" id="smtp_port" value="{{ system_settings.get('smtp_port', 587) }}"></td>
          </tr>
          <tr>
            <td><label for="smtp_starttls"><b>Use STARTTLS</b></label></td>
            <td><input type="checkbox" name="smtp_starttls" id="smtp_starttls" {% if system_settings.get('smtp_starttls', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="warning_mode"><b>Messaging Options</b></label></td>
            <td>
              <select name="warning_mode" id="warning_mode">
                <option value="NONE" {% if system_settings.get('warning_mode','NONE')|upper == "NONE" %}selected{% endif %}>None</option>
                <option value="EMAIL" {% if system_settings.get('warning_mode','NONE')|upper == "EMAIL" %}selected{% endif %}>eMail</option>
                <option value="SMS" {% if system_settings.get('warning_mode','NONE')|upper == "SMS" %}selected{% endif %}>SMS</option>
                <option value="BOTH" {% if system_settings.get('warning_mode','NONE')|upper == "BOTH" %}selected{% endif %}>Both</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="email"><b>Recipient eMail Address</b></label></td>
            <td><input type="email" name="email" id="email" value="{{ system_settings.get('email','') }}"></td>
          </tr>
          <tr>
            <td><label for="mobile"><b>Recipient Cell Phone Number</b></label></td>
            <td><input type="text" name="mobile" id="mobile" value="{{ system_settings.get('mobile','') }}"></td>
          </tr>
          <tr>
            <td><label for="sms_gateway_domain"><b>SMS Gateway Domain</b></label></td>
            <td><input type="text" name="sms_gateway_domain" id="sms_gateway_domain" value="{{ system_settings.get('sms_gateway_domain','') }}" placeholder="e.g., txt.att.net"></td>
          </tr>
        </table>

        <h3 style="text-align: center; margin-top: 30px;">Temperature Control Notifications</h3>
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td colspan="2" style="text-align: center; font-style: italic; padding: 10px;">
              Select which temperature control events should trigger notifications
            </td>
          </tr>
          <tr>
            <td><label for="enable_temp_below_low_limit"><b>Temperature Below Low Limit</b></label></td>
            <td><input type="checkbox" name="enable_temp_below_low_limit" id="enable_temp_below_low_limit" {% if system_settings.get('temp_control_notifications', {}).get('enable_temp_below_low_limit', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_temp_above_high_limit"><b>Temperature Above High Limit</b></label></td>
            <td><input type="checkbox" name="enable_temp_above_high_limit" id="enable_temp_above_high_limit" {% if system_settings.get('temp_control_notifications', {}).get('enable_temp_above_high_limit', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_heating_on"><b>Heating Turned On</b></label></td>
            <td><input type="checkbox" name="enable_heating_on" id="enable_heating_on" {% if system_settings.get('temp_control_notifications', {}).get('enable_heating_on', False) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_heating_off"><b>Heating Turned Off</b></label></td>
            <td><input type="checkbox" name="enable_heating_off" id="enable_heating_off" {% if system_settings.get('temp_control_notifications', {}).get('enable_heating_off', False) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_cooling_on"><b>Cooling Turned On</b></label></td>
            <td><input type="checkbox" name="enable_cooling_on" id="enable_cooling_on" {% if system_settings.get('temp_control_notifications', {}).get('enable_cooling_on', False) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_cooling_off"><b>Cooling Turned Off</b></label></td>
            <td><input type="checkbox" name="enable_cooling_off" id="enable_cooling_off" {% if system_settings.get('temp_control_notifications', {}).get('enable_cooling_off', False) %}checked{% endif %}></td>
          </tr>
        </table>

        <h3 style="text-align: center; margin-top: 30px;">Batch Notifications</h3>
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td colspan="2" style="text-align: center; font-style: italic; padding: 10px;">
              System-wide settings that apply to each active tilt
            </td>
          </tr>
          <tr>
            <td><label for="enable_loss_of_signal"><b>Loss of Signal Alert</b></label></td>
            <td><input type="checkbox" name="enable_loss_of_signal" id="enable_loss_of_signal" {% if system_settings.get('batch_notifications', {}).get('enable_loss_of_signal', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="loss_of_signal_timeout_minutes"><b>Loss of Signal Timeout (minutes)</b></label></td>
            <td><input type="number" name="loss_of_signal_timeout_minutes" id="loss_of_signal_timeout_minutes" value="{{ system_settings.get('batch_notifications', {}).get('loss_of_signal_timeout_minutes', 30) }}" min="1"></td>
          </tr>
          <tr>
            <td><label for="enable_fermentation_starting"><b>Fermentation Starting Alert</b></label></td>
            <td><input type="checkbox" name="enable_fermentation_starting" id="enable_fermentation_starting" {% if system_settings.get('batch_notifications', {}).get('enable_fermentation_starting', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_daily_report"><b>Daily Progress Report</b></label></td>
            <td><input type="checkbox" name="enable_daily_report" id="enable_daily_report" {% if system_settings.get('batch_notifications', {}).get('enable_daily_report', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="daily_report_time"><b>Daily Report Time (HH:MM, 24-hour format)</b></label></td>
            <td><input type="time" name="daily_report_time" id="daily_report_time" value="{{ system_settings.get('batch_notifications', {}).get('daily_report_time', '09:00') }}"></td>
          </tr>
        </table>

        <div style="text-align:center; margin-top:20px;">
          <button type="submit" class="btn-primary">Save</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>
      </div>

      <!-- Logging Integrations Tab -->
      <div id="logging-integrations" class="tab-content">
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td><label for="external_refresh_rate"><b>External Post Interval (minutes)</b></label></td>
            <td><input type="number" name="external_refresh_rate" id="external_refresh_rate" value="{{ system_settings.get('external_refresh_rate','0') }}"></td>
          </tr>

          {% for i in range(3) %}
          <tr>
            <td style="width:35%;">
              <label for="external_name_{{ i }}"><b>Name {{ i + 1 }}</b></label><br>
              <label for="external_url_{{ i }}"><b>URL {{ i + 1 }}</b></label>
            </td>
            <td>
              <input type="text" name="external_name_{{ i }}" id="external_name_{{ i }}" value="{{ system_settings.get('external_name_' ~ i, '') }}"><br>
              <input type="text" name="external_url_{{ i }}" id="external_url_{{ i }}" value="{{ system_settings.get('external_url_' ~ i, '') }}">
            </td>
          </tr>
          {% endfor %}

          <tr>
            <td><label for="external_method"><b>External POST Method</b></label></td>
            <td>
              <select name="external_method" id="external_method">
                <option value="POST" {% if (system_settings.get('external_method','POST')|upper) == 'POST' %}selected{% endif %}>POST</option>
                <option value="GET" {% if (system_settings.get('external_method','POST')|upper) == 'GET' %}selected{% endif %}>GET</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="external_content_type"><b>External Content Type</b></label></td>
            <td>
              <select name="external_content_type" id="external_content_type">
                <option value="form" {% if (system_settings.get('external_content_type','form')|lower) == 'form' %}selected{% endif %}>form (application/x-www-form-urlencoded)</option>
                <option value="json" {% if (system_settings.get('external_content_type','form')|lower) == 'json' %}selected{% endif %}>json (application/json)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="external_timeout_seconds"><b>External Request Timeout (seconds)</b></label></td>
            <td><input type="number" name="external_timeout_seconds" id="external_timeout_seconds" value="{{ system_settings.get('external_timeout_seconds',8) }}"></td>
          </tr>
          <tr>
            <td><label for="external_field_map"><b>External Field Map (JSON)</b></label></td>
            <td>
              <textarea name="external_field_map" id="external_field_map" rows="4" placeholder='{"gravity":"gravity","temp_f":"temp","tilt_color":"device"}'>{{ system_settings.get('external_field_map','') }}</textarea>
              <div style="font-size:0.9em;color:#666;margin-top:6px;">Optional JSON mapping of logical field names to the remote service's parameter names.</div>
            </td>
          </tr>
        </table>

        <div style="text-align:center; margin-top:20px;">
          <button type="submit" class="btn-primary">Save</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>
      </div>

      <!-- Backup/Restore Tab -->
      <div id="backup-restore" class="tab-content">
        <h3 style="text-align: center; margin-top: 20px;">System Backup and Restore</h3>
        <p style="text-align: center; font-style: italic; color: #666; margin-bottom: 30px;">
          Backup all programs and data to a USB device, or restore from a previous backup.
        </p>
        
        <table class="config-table" style="width: 70%; margin: auto;">
          <tr>
            <td colspan="2" style="background-color: #f5f5f5; padding: 15px;">
              <h4 style="margin: 0 0 10px 0;">Backup Configuration</h4>
              <label for="backup_path"><b>USB Mount Path</b></label><br>
              <input type="text" id="backup_path" value="/media/usb" placeholder="/media/usb" style="width: 100%; margin-top: 5px;">
              <div style="font-size:0.9em;color:#666;margin-top:6px;">
                Enter the path where your USB device is mounted (e.g., /media/usb, /mnt/usb0)
              </div>
            </td>
          </tr>
          
          <tr>
            <td colspan="2" style="padding: 20px; text-align: center;">
              <button type="button" class="btn-primary" onclick="createBackup()" style="font-size: 18px; padding: 15px 40px;">
                Create Backup
              </button>
              <div id="backup-status" style="margin-top: 15px; font-weight: bold;"></div>
            </td>
          </tr>
          
          <tr>
            <td colspan="2" style="background-color: #f5f5f5; padding: 15px;">
              <h4 style="margin: 0 0 10px 0;">Restore from Backup</h4>
              <button type="button" class="btn-secondary" onclick="refreshBackupList()" style="margin-bottom: 10px;">
                Refresh Backup List
              </button>
              <div id="backup-list-container" style="margin-top: 10px;">
                <p style="font-style: italic; color: #666;">Click "Refresh Backup List" to see available backups.</p>
              </div>
            </td>
          </tr>
        </table>
        
        <div style="text-align:center; margin-top:20px;">
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary">Back to Settings</button>
        </div>
      </div>

    </form>

    <div style="text-align:center; margin-top:12px;">
      <form action="/" method="get" style="display:inline;">
        <button type="submit" class="btn-action cancel">Return to Dashboard</button>
      </form>
    </div>
  </div>

  <script>
    function openTab(evt, tabName) {
      // Hide all tab contents
      var tabContents = document.getElementsByClassName("tab-content");
      for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      
      // Remove active class from all tab buttons
      var tabButtons = document.getElementsByClassName("tab-button");
      for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      
      // Show the selected tab and mark button as active
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }
    
    function createBackup() {
      const backupPath = document.getElementById('backup_path').value;
      const statusDiv = document.getElementById('backup-status');
      
      statusDiv.innerHTML = '<span style="color: blue;">Creating backup, please wait...</span>';
      
      fetch('/backup_system', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          statusDiv.innerHTML = '<span style="color: green;">✓ ' + data.message + '<br>Size: ' + data.size_mb + ' MB</span>';
          // Refresh the backup list after successful backup
          setTimeout(refreshBackupList, 1000);
        } else {
          statusDiv.innerHTML = '<span style="color: red;">✗ ' + data.message + '</span>';
        }
      })
      .catch(error => {
        statusDiv.innerHTML = '<span style="color: red;">✗ Error: ' + error.message + '</span>';
      });
    }
    
    function refreshBackupList() {
      const backupPath = document.getElementById('backup_path').value;
      const container = document.getElementById('backup-list-container');
      
      container.innerHTML = '<p style="font-style: italic; color: #666;">Loading backups...</p>';
      
      fetch('/list_backups', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.backups.length > 0) {
          let html = '<table style="width: 100%; border-collapse: collapse;">';
          html += '<tr style="background-color: #e0e0e0;"><th style="padding: 8px; text-align: left;">Backup File</th><th style="padding: 8px;">Size (MB)</th><th style="padding: 8px;">Date</th><th style="padding: 8px;">Action</th></tr>';
          
          data.backups.forEach(backup => {
            html += '<tr style="border-bottom: 1px solid #ccc;">';
            html += '<td style="padding: 8px;">' + backup.filename + '</td>';
            html += '<td style="padding: 8px; text-align: center;">' + backup.size_mb + '</td>';
            html += '<td style="padding: 8px; text-align: center;">' + backup.modified + '</td>';
            html += '<td style="padding: 8px; text-align: center;">';
            html += '<button type="button" class="btn-primary" onclick="restoreBackup(\'' + backup.filename + '\')" style="font-size: 14px; padding: 5px 15px;">Restore</button>';
            html += '</td>';
            html += '</tr>';
          });
          
          html += '</table>';
          container.innerHTML = html;
        } else if (data.success && data.backups.length === 0) {
          container.innerHTML = '<p style="font-style: italic; color: #666;">No backups found at ' + data.path + '</p>';
        } else {
          container.innerHTML = '<p style="color: red;">' + data.message + '</p>';
        }
      })
      .catch(error => {
        container.innerHTML = '<p style="color: red;">Error loading backups: ' + error.message + '</p>';
      });
    }
    
    function restoreBackup(filename) {
      if (!confirm('Are you sure you want to restore from this backup?\n\nThis will overwrite current files and requires an application restart.\n\nBackup: ' + filename)) {
        return;
      }
      
      const backupPath = document.getElementById('backup_path').value;
      const container = document.getElementById('backup-list-container');
      
      container.innerHTML = '<p style="font-style: italic; color: blue;">Restoring from backup, please wait...</p>';
      
      fetch('/restore_system', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath) + '&backup_filename=' + encodeURIComponent(filename)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          if (data.restart_required) {
            container.innerHTML = '<p style="color: green; font-weight: bold;">✓ Restore complete! Please restart the application.</p>';
          }
        } else {
          container.innerHTML = '<p style="color: red;">✗ ' + data.message + '</p>';
        }
      })
      .catch(error => {
        container.innerHTML = '<p style="color: red;">✗ Error: ' + error.message + '</p>';
      });
    }
  </script>
</body>
</html>