<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>System Settings</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* small spacing tweaks to match your UI */
    .config-table input[type="text"], .config-table input[type="email"], .config-table input[type="number"], .config-table input[type="password"], .config-table select, .config-table textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px;
    }
    .config-table td { vertical-align: top; padding: 6px 8px; }
    
    /* Tab navigation styles */
    .tab-navigation {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px auto;
      max-width: 800px;
    }
    
    .tab-button {
      padding: 12px 24px;
      background-color: #8B4513;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      border-radius: 5px 5px 0 0;
      transition: background-color 0.3s;
    }
    
    .tab-button:hover {
      background-color: #A0522D;
    }
    
    .tab-button.active {
      background-color: #654321;
      border-bottom: 3px solid #FFA500;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body class="page-bg">
  <div class="temp-config-setup-ribbon">
    <div class="temp-header">
      <div class="temp-title">SYSTEM SETTINGS CONFIGURATION</div>
      <div class="temp-subtitle">Edit global system configuration</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
      <button type="button" class="tab-button {% if active_tab == 'main-settings' %}active{% endif %}" onclick="openTab(event, 'main-settings')">Main Settings</button>
      <button type="button" class="tab-button {% if active_tab == 'push-email' %}active{% endif %}" onclick="openTab(event, 'push-email')">PUSH/eMail</button>
      <button type="button" class="tab-button {% if active_tab == 'logging-integrations' %}active{% endif %}" onclick="openTab(event, 'logging-integrations')">Logging Integrations</button>
      <button type="button" class="tab-button {% if active_tab == 'backup-restore' %}active{% endif %}" onclick="openTab(event, 'backup-restore')">Backup/Restore</button>
    </div>

    <form action="{{ url_for('update_system_config') }}" method="post" class="temp-config-form">
      <!-- Hidden field to track which tab is active when form is submitted -->
      <input type="hidden" id="active_tab" name="active_tab" value="{{ active_tab }}">
      
      <!-- Main Settings Tab -->
      <div id="main-settings" class="tab-content {% if active_tab == 'main-settings' %}active{% endif %}">
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td><label for="brewery_name"><b>Brewery Name</b></label></td>
            <td><input type="text" name="brewery_name" id="brewery_name" value="{{ system_settings.get('brewery_name','') }}"></td>
          </tr>
          <tr>
            <td><label for="brewer_name"><b>Brewer Name</b></label></td>
            <td><input type="text" name="brewer_name" id="brewer_name" value="{{ system_settings.get('brewer_name','') }}"></td>
          </tr>
          <tr>
            <td><label for="street"><b>Street Address</b></label></td>
            <td><input type="text" name="street" id="street" value="{{ system_settings.get('street','') }}"></td>
          </tr>
          <tr>
            <td><label for="city"><b>City</b></label></td>
            <td><input type="text" name="city" id="city" value="{{ system_settings.get('city','') }}"></td>
          </tr>
          <tr>
            <td><label for="state"><b>State</b></label></td>
            <td><input type="text" name="state" id="state" value="{{ system_settings.get('state','') }}"></td>
          </tr>
          <tr>
            <td><label for="timezone"><b>Time Zone</b></label></td>
            <td>
              <select name="timezone" id="timezone">
                <option value="">Select a timezone</option>
                <option value="America/New_York" {% if system_settings.get('timezone','') == 'America/New_York' %}selected{% endif %}>Eastern (America/New_York)</option>
                <option value="America/Chicago" {% if system_settings.get('timezone','') == 'America/Chicago' %}selected{% endif %}>Central (America/Chicago)</option>
                <option value="America/Denver" {% if system_settings.get('timezone','') == 'America/Denver' %}selected{% endif %}>Mountain (America/Denver)</option>
                <option value="America/Phoenix" {% if system_settings.get('timezone','') == 'America/Phoenix' %}selected{% endif %}>Arizona (America/Phoenix)</option>
                <option value="America/Los_Angeles" {% if system_settings.get('timezone','') == 'America/Los_Angeles' %}selected{% endif %}>Pacific (America/Los_Angeles)</option>
                <option value="America/Anchorage" {% if system_settings.get('timezone','') == 'America/Anchorage' %}selected{% endif %}>Alaska (America/Anchorage)</option>
                <option value="Pacific/Honolulu" {% if system_settings.get('timezone','') == 'Pacific/Honolulu' %}selected{% endif %}>Hawaii (Pacific/Honolulu)</option>
                <option value="UTC" {% if system_settings.get('timezone','') == 'UTC' %}selected{% endif %}>UTC</option>
                <option value="Europe/London" {% if system_settings.get('timezone','') == 'Europe/London' %}selected{% endif %}>UK (Europe/London)</option>
                <option value="Europe/Paris" {% if system_settings.get('timezone','') == 'Europe/Paris' %}selected{% endif %}>Central Europe (Europe/Paris)</option>
                <option value="Asia/Tokyo" {% if system_settings.get('timezone','') == 'Asia/Tokyo' %}selected{% endif %}>Japan (Asia/Tokyo)</option>
                <option value="Australia/Sydney" {% if system_settings.get('timezone','') == 'Australia/Sydney' %}selected{% endif %}>Australia East (Australia/Sydney)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="timestamp_format"><b>Timestamp Format</b></label></td>
            <td>
              <select name="timestamp_format" id="timestamp_format">
                <option value="">Select a format</option>
                <option value="%Y-%m-%d %H:%M:%S" {% if system_settings.get('timestamp_format','') == '%Y-%m-%d %H:%M:%S' %}selected{% endif %}>YYYY-MM-DD HH:MM:SS (2026-01-21 16:30:29)</option>
                <option value="%m/%d/%Y %I:%M:%S %p" {% if system_settings.get('timestamp_format','') == '%m/%d/%Y %I:%M:%S %p' %}selected{% endif %}>MM/DD/YYYY HH:MM:SS AM/PM (01/21/2026 04:30:29 PM)</option>
                <option value="%d/%m/%Y %H:%M:%S" {% if system_settings.get('timestamp_format','') == '%d/%m/%Y %H:%M:%S' %}selected{% endif %}>DD/MM/YYYY HH:MM:SS (21/01/2026 16:30:29)</option>
                <option value="%Y-%m-%d %I:%M:%S %p" {% if system_settings.get('timestamp_format','') == '%Y-%m-%d %I:%M:%S %p' %}selected{% endif %}>YYYY-MM-DD HH:MM:SS AM/PM (2026-01-21 04:30:29 PM)</option>
                <option value="%b %d, %Y %I:%M %p" {% if system_settings.get('timestamp_format','') == '%b %d, %Y %I:%M %p' %}selected{% endif %}>Mon DD, YYYY HH:MM AM/PM (Jan 21, 2026 04:30 PM)</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>
              <label for="update_interval"><b>Update Interval (minutes)</b></label>
              <div style="font-size:0.85em;color:#666;margin-top:4px;">Frequency of control loop checks for temperature adjustments and readings</div>
            </td>
            <td><input type="number" name="update_interval" id="update_interval" value="{{ system_settings.get('update_interval','1') }}"></td>
          </tr>
          <tr>
            <td><label for="tilt_logging_interval_minutes"><b>Tilt Reading Logging Interval (minutes)</b></label></td>
            <td><input type="number" name="tilt_logging_interval_minutes" id="tilt_logging_interval_minutes" value="{{ system_settings.get('tilt_logging_interval_minutes','15') }}"></td>
          </tr>
          <tr>
            <td><label for="temp_logging_interval"><b>Temperature Control Logging Interval (minutes)</b></label></td>
            <td><input type="number" name="temp_logging_interval" id="temp_logging_interval" value="{{ system_settings.get('temp_logging_interval','') }}"></td>
          </tr>

          <tr>
            <td>
              <label for="kasa_rate_limit_seconds"><b>Kasa Rate Limit (seconds)</b></label>
              <div style="font-size:0.85em;color:#666;margin-top:4px;">Minimum time between commands to Kasa smart plugs to prevent overload</div>
            </td>
            <td><input type="number" name="kasa_rate_limit_seconds" id="kasa_rate_limit_seconds" value="{{ system_settings.get('kasa_rate_limit_seconds', 10) }}"></td>
          </tr>
        </table>

        <div style="text-align:center; margin-top:20px;">
          <button type="button" onclick="window.location='/'" class="btn-action">Dashboard</button>
          <button type="submit" class="btn-primary" style="margin-left:16px;">Save</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>
      </div>

      <!-- PUSH/eMail Tab -->
      <div id="push-email" class="tab-content {% if active_tab == 'push-email' %}active{% endif %}">
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td><label for="sending_email"><b>Sending Email Address</b></label></td>
            <td>
              <input type="email" name="sending_email" id="sending_email" value="{{ system_settings.get('sending_email','') }}" onchange="updateSmtpSettings()">
            </td>
          </tr>
          <tr>
            <td><label for="sending_email_password"><b>Sending Email Password</b></label></td>
            <td>
              <input type="password" name="sending_email_password" id="sending_email_password" placeholder="{% if system_settings.get('smtp_password') %}Leave blank to keep existing password{% else %}Enter password{% endif %}">
              {% if system_settings.get('smtp_password') %}
              <span style="color: green; font-size: 0.9em; margin-left: 8px;">âœ“ Password saved</span>
              {% endif %}
            </td>
          </tr>
          <tr>
            <td><label for="smtp_host"><b>SMTP Server Host</b></label></td>
            <td><input type="text" name="smtp_host" id="smtp_host" value="{{ system_settings.get('smtp_host', 'smtp.gmail.com') }}" placeholder="e.g., smtp.gmail.com"></td>
          </tr>
          <tr>
            <td><label for="smtp_port"><b>SMTP Server Port</b></label></td>
            <td><input type="number" name="smtp_port" id="smtp_port" value="{{ system_settings.get('smtp_port', 587) }}"></td>
          </tr>
          <tr>
            <td>
              <label for="smtp_starttls"><b>Use STARTTLS</b></label>
              <div style="font-size:0.85em;color:#666;margin-top:4px;">Encrypts email communication for security. Keep checked for Gmail and most modern email services.</div>
            </td>
            <td><input type="checkbox" name="smtp_starttls" id="smtp_starttls" {% if system_settings.get('smtp_starttls', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="warning_mode"><b>Messaging Options</b></label></td>
            <td>
              <select name="warning_mode" id="warning_mode">
                <option value="NONE" {% if system_settings.get('warning_mode','NONE')|upper == "NONE" %}selected{% endif %}>None</option>
                <option value="EMAIL" {% if system_settings.get('warning_mode','NONE')|upper == "EMAIL" %}selected{% endif %}>eMail</option>
                <option value="PUSH" {% if system_settings.get('warning_mode','NONE')|upper == "PUSH" %}selected{% endif %}>Push</option>
                <option value="BOTH" {% if system_settings.get('warning_mode','NONE')|upper == "BOTH" %}selected{% endif %}>Both</option>
              </select>
            </td>
          </tr>
          <tr>
            <td><label for="email"><b>Recipient eMail Address</b></label></td>
            <td><input type="email" name="email" id="email" value="{{ system_settings.get('email','') }}"></td>
          </tr>
          
          <!-- Push Notification Configuration -->
          <tr>
            <td colspan="2" style="padding-top: 20px;">
              <h4 style="margin: 0;">Push Notification Configuration</h4>
              <p style="margin: 5px 0; font-size: 0.9em; color: #666;">
                Push notifications work across iOS, Android, and desktop. More reliable and cost-effective than SMS.
              </p>
            </td>
          </tr>
          <tr>
            <td><label for="push_provider"><b>Push Provider</b></label></td>
            <td>
              <select name="push_provider" id="push_provider" onchange="togglePushProvider()">
                <option value="pushover" {% if system_settings.get('push_provider','pushover') == 'pushover' %}selected{% endif %}>Pushover ($5 one-time - Recommended)</option>
                <option value="ntfy" {% if system_settings.get('push_provider','pushover') == 'ntfy' %}selected{% endif %}>ntfy (100% FREE - Open Source)</option>
              </select>
            </td>
          </tr>
          
          <!-- Pushover-specific fields -->
          <tr class="pushover-field">
            <td><label for="pushover_user_key"><b>Pushover User Key</b></label></td>
            <td><input type="text" name="pushover_user_key" id="pushover_user_key" value="{{ system_settings.get('pushover_user_key','') }}" placeholder="Your 30-character user key"></td>
          </tr>
          <tr class="pushover-field">
            <td><label for="pushover_api_token"><b>Pushover API Token</b></label></td>
            <td><input type="password" name="pushover_api_token" id="pushover_api_token" placeholder="{% if system_settings.get('pushover_api_token','') %}â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢{% else %}Your API Token{% endif %}"></td>
          </tr>
          <tr class="pushover-field">
            <td><label for="pushover_device"><b>Device Name (Optional)</b></label></td>
            <td><input type="text" name="pushover_device" id="pushover_device" value="{{ system_settings.get('pushover_device','') }}" placeholder="Leave blank for all devices"></td>
          </tr>
          <tr class="pushover-field">
            <td colspan="2">
              <div style="background-color: #d1ecf1; border: 1px solid #bee5eb; border-radius: 5px; padding: 12px; margin: 10px 0;">
                <strong style="color: #0c5460;">ðŸ“± Pushover Setup ($5 one-time per platform)</strong>
                <ol style="margin: 8px 0; padding-left: 20px; color: #0c5460; font-size: 0.9em;">
                  <li>Sign up at <a href="https://pushover.net" target="_blank" style="color: #0056b3;">pushover.net</a> (30-day free trial)</li>
                  <li>Install Pushover app on your phone/device from App Store or Google Play</li>
                  <li>Get your User Key from the dashboard (appears after login)</li>
                  <li>Create an application at <a href="https://pushover.net/apps/build" target="_blank" style="color: #0056b3;">pushover.net/apps/build</a></li>
                  <li>Copy the API Token from your application</li>
                  <li>Enter User Key and API Token above and Save</li>
                  <li>Use "Test Push" button below to verify</li>
                </ol>
                <p style="margin: 5px 0; font-size: 0.85em; color: #0c5460;">
                  One-time $5 fee per platform after 30-day trial. Very reliable and feature-rich!
                </p>
              </div>
            </td>
          </tr>
          
          <!-- ntfy fields -->
          <tr class="ntfy-field" style="display: none;">
            <td><label for="ntfy_server"><b>ntfy Server URL</b></label></td>
            <td><input type="text" name="ntfy_server" id="ntfy_server" value="{{ system_settings.get('ntfy_server','https://ntfy.sh') }}" placeholder="https://ntfy.sh"></td>
          </tr>
          <tr class="ntfy-field" style="display: none;">
            <td><label for="ntfy_topic"><b>ntfy Topic</b></label></td>
            <td><input type="text" name="ntfy_topic" id="ntfy_topic" value="{{ system_settings.get('ntfy_topic','') }}" placeholder="my_unique_fermenter_topic"></td>
          </tr>
          <tr class="ntfy-field" style="display: none;">
            <td><label for="ntfy_auth_token"><b>Auth Token (Optional)</b></label></td>
            <td><input type="password" name="ntfy_auth_token" id="ntfy_auth_token" placeholder="{% if system_settings.get('ntfy_auth_token','') %}â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢{% else %}Leave blank if not required{% endif %}"></td>
          </tr>
          <tr class="ntfy-field" style="display: none;">
            <td colspan="2">
              <div style="background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 12px; margin: 10px 0;">
                <strong style="color: #155724;">ðŸ†“ ntfy Setup (100% FREE!)</strong>
                <ol style="margin: 8px 0; padding-left: 20px; color: #155724; font-size: 0.9em;">
                  <li>Install ntfy app on your phone from <a href="https://ntfy.sh" target="_blank" style="color: #0056b3;">ntfy.sh</a></li>
                  <li>Choose a unique topic name (e.g., "johns_fermenter_2026")</li>
                  <li>Subscribe to that topic in the ntfy app</li>
                  <li>Enter the same topic name above</li>
                  <li>Use public server (https://ntfy.sh) or self-host for privacy</li>
                  <li>Click Save and use "Test Push" button</li>
                </ol>
                <p style="margin: 5px 0; font-size: 0.85em; color: #155724;">
                  <strong>Zero cost!</strong> Open-source, privacy-friendly, works great for hobbyists.
                </p>
              </div>
            </td>
          </tr>
        </table>

        <h3 style="text-align: center; margin-top: 30px;">Temperature Control Notifications</h3>
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td colspan="2" style="text-align: center; font-style: italic; padding: 10px;">
              Select which temperature control events should trigger notifications
            </td>
          </tr>
          <tr>
            <td><label for="enable_temp_below_low_limit"><b>Temperature Below Low Limit</b></label></td>
            <td><input type="checkbox" name="enable_temp_below_low_limit" id="enable_temp_below_low_limit" {% if system_settings.get('temp_control_notifications', {}).get('enable_temp_below_low_limit', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_temp_above_high_limit"><b>Temperature Above High Limit</b></label></td>
            <td><input type="checkbox" name="enable_temp_above_high_limit" id="enable_temp_above_high_limit" {% if system_settings.get('temp_control_notifications', {}).get('enable_temp_above_high_limit', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_heating_on"><b>Heating Turned On</b></label></td>
            <td><input type="checkbox" name="enable_heating_on" id="enable_heating_on" {% if system_settings.get('temp_control_notifications', {}).get('enable_heating_on', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_heating_off"><b>Heating Turned Off</b></label></td>
            <td><input type="checkbox" name="enable_heating_off" id="enable_heating_off" {% if system_settings.get('temp_control_notifications', {}).get('enable_heating_off', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_cooling_on"><b>Cooling Turned On</b></label></td>
            <td><input type="checkbox" name="enable_cooling_on" id="enable_cooling_on" {% if system_settings.get('temp_control_notifications', {}).get('enable_cooling_on', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_cooling_off"><b>Cooling Turned Off</b></label></td>
            <td><input type="checkbox" name="enable_cooling_off" id="enable_cooling_off" {% if system_settings.get('temp_control_notifications', {}).get('enable_cooling_off', True) %}checked{% endif %}></td>
          </tr>
        </table>

        <h3 style="text-align: center; margin-top: 30px;">Batch Notifications</h3>
        <table class="config-table" style="width: 60%; margin: auto;">
          <tr>
            <td colspan="2" style="text-align: center; font-style: italic; padding: 10px;">
              System-wide settings that apply to each active tilt
            </td>
          </tr>
          <tr>
            <td><label for="enable_loss_of_signal"><b>Loss of Signal Alert</b></label></td>
            <td><input type="checkbox" name="enable_loss_of_signal" id="enable_loss_of_signal" {% if system_settings.get('batch_notifications', {}).get('enable_loss_of_signal', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="loss_of_signal_timeout_minutes"><b>Continuous Loss of Signal to Trigger Alert (Minutes)</b></label></td>
            <td><input type="number" name="loss_of_signal_timeout_minutes" id="loss_of_signal_timeout_minutes" value="{{ system_settings.get('batch_notifications', {}).get('loss_of_signal_timeout_minutes', 30) }}" min="1"></td>
          </tr>
          <tr>
            <td><label for="enable_fermentation_starting"><b>Fermentation Starting Alert</b></label></td>
            <td><input type="checkbox" name="enable_fermentation_starting" id="enable_fermentation_starting" {% if system_settings.get('batch_notifications', {}).get('enable_fermentation_starting', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td>
              <label for="enable_fermentation_completion"><b>Fermentation Completion Alert</b></label>
              <div style="font-size:0.85em;color:#666;margin-top:4px;">Triggers when gravity hasn't decreased in 24 hours after fermentation started</div>
            </td>
            <td><input type="checkbox" name="enable_fermentation_completion" id="enable_fermentation_completion" {% if system_settings.get('batch_notifications', {}).get('enable_fermentation_completion', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="enable_daily_report"><b>Daily Progress Report</b></label></td>
            <td><input type="checkbox" name="enable_daily_report" id="enable_daily_report" {% if system_settings.get('batch_notifications', {}).get('enable_daily_report', True) %}checked{% endif %}></td>
          </tr>
          <tr>
            <td><label for="daily_report_time"><b>Daily Report Time (HH:MM, 24-hour format)</b></label></td>
            <td><input type="time" name="daily_report_time" id="daily_report_time" value="{{ system_settings.get('batch_notifications', {}).get('daily_report_time', '09:00') }}"></td>
          </tr>
        </table>

        <h3 style="text-align: center; margin-top: 30px;">Manual Test Buttons</h3>
        <div style="text-align: center; margin-top: 20px;">
          <p style="font-style: italic; color: #666; margin-bottom: 15px;">
            Use these buttons to test your notification settings
          </p>
          <button type="button" class="btn-action" onclick="testEmail()" style="margin-right: 10px;">
            Test Email
          </button>
          <button type="button" class="btn-action" onclick="testPush()">
            Test Push Notification
          </button>
          <div id="test-result" style="margin-top: 15px; font-weight: bold;"></div>
        </div>

        <div style="text-align:center; margin-top:20px;">
          <button type="button" onclick="window.location='/'" class="btn-action">Dashboard</button>
          <button type="button" onclick="switchToTab('main-settings')" class="btn-action" style="margin-left:16px;">Back</button>
          <button type="submit" class="btn-primary" style="margin-left:16px;">Save</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>
      </div>

      <!-- Logging Integrations Tab -->
      <div id="logging-integrations" class="tab-content {% if active_tab == 'logging-integrations' %}active{% endif %}">
        <table class="config-table" style="width: 80%; margin: auto;">
          <tr>
            <td><label for="external_refresh_rate"><b>External Post Interval (minutes)</b></label></td>
            <td><input type="number" name="external_refresh_rate" id="external_refresh_rate" value="{{ system_settings.get('external_refresh_rate','15') }}"></td>
          </tr>
        </table>

        {% for i in range(3) %}
        <div style="border: 1px solid #ccc; margin: 20px auto; padding: 15px; width: 80%; background-color: #f9f9f9; border-radius: 5px;">
          <h3 style="margin-top: 0; color: #333;">External Service {{ i + 1 }}</h3>
          
          <table class="config-table" style="width: 100%;">
            <tr>
              <td style="width:35%;"><label for="external_name_{{ i }}"><b>Service Name</b></label></td>
              <td><input type="text" name="external_name_{{ i }}" id="external_name_{{ i }}" value="{{ external_urls[i].get('name', '') }}" placeholder="e.g., Brewers Friend" maxlength="30"></td>
            </tr>
            <tr>
              <td><label for="external_url_{{ i }}"><b>URL</b></label></td>
              <td><input type="text" name="external_url_{{ i }}" id="external_url_{{ i }}" value="{{ external_urls[i].get('url', '') }}" placeholder="https://..." onchange="toggleUrlSettings({{ i }})"></td>
            </tr>
          </table>
          
          <!-- Test Connection Button -->
          <div style="text-align: center; margin-top: 15px;">
            <button type="button" class="btn-action" onclick="testExternalConnection({{ i }})" style="margin-bottom: 10px;">
              Test Connection
            </button>
            <div id="external-test-result-{{ i }}" style="margin-top: 10px; font-weight: bold;"></div>
          </div>

          <div id="url_settings_{{ i }}" style="{% if not external_urls[i].get('url') %}display:none;{% endif %} margin-top: 10px; padding: 10px; background-color: #fff; border-left: 3px solid #4CAF50;">
            <h4 style="margin-top: 0; color: #555;">Connection Settings</h4>
            <table class="config-table" style="width: 100%;">
              <tr>
                <td style="width:35%;"><label for="external_method_{{ i }}"><b>HTTP Method</b></label></td>
                <td>
                  <select name="external_method_{{ i }}" id="external_method_{{ i }}">
                    <option value="POST" {% if external_urls[i].get('method', 'POST') == 'POST' %}selected{% endif %}>POST</option>
                    <option value="GET" {% if external_urls[i].get('method', 'POST') == 'GET' %}selected{% endif %}>GET</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><label for="external_content_type_{{ i }}"><b>Content Type</b></label></td>
                <td>
                  <select name="external_content_type_{{ i }}" id="external_content_type_{{ i }}">
                    <option value="form" {% if external_urls[i].get('content_type', 'form') == 'form' %}selected{% endif %}>form (application/x-www-form-urlencoded)</option>
                    <option value="json" {% if external_urls[i].get('content_type', 'form') == 'json' %}selected{% endif %}>json (application/json)</option>
                  </select>
                </td>
              </tr>
              <tr>
                <td><label for="external_timeout_seconds_{{ i }}"><b>Request Timeout (seconds)</b></label></td>
                <td>
                  <input type="number" name="external_timeout_seconds_{{ i }}" id="external_timeout_seconds_{{ i }}" value="{{ external_urls[i].get('timeout_seconds', 8) }}" min="1" max="60">
                  <div style="font-size:0.85em;color:#666;margin-top:4px;">Maximum time to wait for a response from the external service before timing out.</div>
                </td>
              </tr>
              <tr>
                <td><label for="external_field_map_id_{{ i }}"><b>Field Map Template</b></label></td>
                <td>
                  <select name="external_field_map_id_{{ i }}" id="external_field_map_id_{{ i }}" onchange="toggleCustomFieldMap({{ i }})">
                    {% for map_id, map_info in predefined_field_maps.items() %}
                    <option value="{{ map_id }}" {% if external_urls[i].get('field_map_id', 'default') == map_id %}selected{% endif %}>
                      {{ map_info.name }} - {{ map_info.description }}
                    </option>
                    {% endfor %}
                  </select>
                </td>
              </tr>
            </table>

            <div id="custom_field_map_{{ i }}" style="{% if external_urls[i].get('field_map_id', 'default') != 'custom' %}display:none;{% endif %} margin-top: 10px;">
              <label for="external_custom_field_map_{{ i }}"><b>Custom Field Map (JSON)</b></label>
              <textarea name="external_custom_field_map_{{ i }}" id="external_custom_field_map_{{ i }}" rows="4" style="width: 100%; font-family: monospace;" placeholder='{"gravity":"gravity","temp_f":"temp","tilt_color":"device"}'>{{ external_urls[i].get('custom_field_map', '') }}</textarea>
              <div style="font-size:0.9em;color:#666;margin-top:6px;">
                JSON mapping of logical field names to remote service parameter names.
                Available fields: timestamp, tilt_color, gravity, temp_f, brew_id, device
              </div>
            </div>
          </div>
        </div>
        {% endfor %}

        <div style="text-align:center; margin-top:20px;">
          <button type="button" onclick="window.location='/'" class="btn-action">Dashboard</button>
          <button type="button" onclick="switchToTab('main-settings')" class="btn-action" style="margin-left:16px;">Back</button>
          <button type="submit" class="btn-primary" style="margin-left:16px;">Save</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>

        <script>
        // Functions for external logging configuration
        function toggleUrlSettings(index) {
          var urlInput = document.getElementById('external_url_' + index);
          var settingsDiv = document.getElementById('url_settings_' + index);
          if (urlInput && settingsDiv) {
            settingsDiv.style.display = urlInput.value.trim() ? 'block' : 'none';
          }
        }

        function toggleCustomFieldMap(index) {
          var selectBox = document.getElementById('external_field_map_id_' + index);
          var customDiv = document.getElementById('custom_field_map_' + index);
          if (selectBox && customDiv) {
            customDiv.style.display = (selectBox.value === 'custom') ? 'block' : 'none';
          }
        }
        </script>
      </div>

      <!-- Backup/Restore Tab -->
      <div id="backup-restore" class="tab-content {% if active_tab == 'backup-restore' %}active{% endif %}">
        <h3 style="text-align: center; margin-top: 20px;">System Backup and Restore</h3>
        <p style="text-align: center; font-style: italic; color: #666; margin-bottom: 30px;">
          Backup all programs and data to a USB device, or restore from a previous backup.
        </p>
        
        <table class="config-table" style="width: 70%; margin: auto;">
          <tr>
            <td colspan="2" style="background-color: #f5f5f5; padding: 15px;">
              <h4 style="margin: 0 0 10px 0;">Backup Configuration</h4>
              <label for="backup_path"><b>USB Mount Path</b></label><br>
              <input type="text" id="backup_path" value="/media/usb" placeholder="/media/usb" style="width: 100%; margin-top: 5px;">
              <div style="font-size:0.9em;color:#666;margin-top:6px;">
                Enter the path where your USB device is mounted (e.g., /media/usb, /mnt/usb0)
              </div>
            </td>
          </tr>
          
          <tr>
            <td colspan="2" style="padding: 20px; text-align: center;">
              <button type="button" class="btn-primary" onclick="createBackup()" style="font-size: 18px; padding: 15px 40px;">
                Create Backup
              </button>
              <div id="backup-status" style="margin-top: 15px; font-weight: bold;"></div>
            </td>
          </tr>
          
          <tr>
            <td colspan="2" style="background-color: #f5f5f5; padding: 15px;">
              <h4 style="margin: 0 0 10px 0;">Restore from Backup</h4>
              <button type="button" class="btn-secondary" onclick="refreshBackupList()" style="margin-bottom: 10px;">
                Refresh Backup List
              </button>
              <div id="backup-list-container" style="margin-top: 10px;">
                <p style="font-style: italic; color: #666;">Click "Refresh Backup List" to see available backups.</p>
              </div>
            </td>
          </tr>
        </table>
        
        <div style="text-align:center; margin-top:20px;">
          <button type="button" onclick="window.location='/'" class="btn-action">Dashboard</button>
          <button type="button" onclick="switchToTab('main-settings')" class="btn-action" style="margin-left:16px;">Back</button>
          <button type="button" onclick="window.location='/system_config'" class="btn-secondary" style="margin-left:16px;">Cancel</button>
        </div>
      </div>

    </form>
  </div>

  <script>
    // Helper function to escape HTML to prevent XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    function openTab(evt, tabName) {
      // Hide all tab contents
      var tabContents = document.getElementsByClassName("tab-content");
      for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      
      // Remove active class from all tab buttons
      var tabButtons = document.getElementsByClassName("tab-button");
      for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      
      // Show the selected tab and mark button as active
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
      
      // Update the hidden field to track the active tab
      document.getElementById('active_tab').value = tabName;
    }
    
    // Helper function to switch to a tab programmatically (for Back buttons)
    function switchToTab(tabName) {
      // Hide all tab contents
      var tabContents = document.getElementsByClassName("tab-content");
      for (var i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove("active");
      }
      
      // Remove active class from all tab buttons
      var tabButtons = document.getElementsByClassName("tab-button");
      for (var i = 0; i < tabButtons.length; i++) {
        tabButtons[i].classList.remove("active");
      }
      
      // Show the selected tab
      document.getElementById(tabName).classList.add("active");
      
      // Activate the corresponding button
      var targetButton = null;
      if (tabName === 'main-settings') targetButton = tabButtons[0];
      else if (tabName === 'push-email') targetButton = tabButtons[1];
      else if (tabName === 'logging-integrations') targetButton = tabButtons[2];
      else if (tabName === 'backup-restore') targetButton = tabButtons[3];
      
      if (targetButton) {
        targetButton.classList.add("active");
      }
    }
    
    function createBackup() {
      const backupPath = document.getElementById('backup_path').value;
      const statusDiv = document.getElementById('backup-status');
      
      statusDiv.innerHTML = '<span style="color: blue;">Creating backup, please wait...</span>';
      
      fetch('/backup_system', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          statusDiv.innerHTML = '<span style="color: green;">âœ“ ' + data.message + '<br>Size: ' + data.size_mb + ' MB</span>';
          // Refresh the backup list after successful backup
          setTimeout(refreshBackupList, 1000);
        } else {
          statusDiv.innerHTML = '<span style="color: red;">âœ— ' + data.message + '</span>';
        }
      })
      .catch(error => {
        statusDiv.innerHTML = '<span style="color: red;">âœ— Error: ' + error.message + '</span>';
      });
    }
    
    function refreshBackupList() {
      const backupPath = document.getElementById('backup_path').value;
      const container = document.getElementById('backup-list-container');
      
      container.innerHTML = '<p style="font-style: italic; color: #666;">Loading backups...</p>';
      
      fetch('/list_backups', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success && data.backups.length > 0) {
          let html = '<table style="width: 100%; border-collapse: collapse;">';
          html += '<tr style="background-color: #e0e0e0;"><th style="padding: 8px; text-align: left;">Backup File</th><th style="padding: 8px;">Size (MB)</th><th style="padding: 8px;">Date</th><th style="padding: 8px;">Action</th></tr>';
          
          data.backups.forEach(backup => {
            // Escape HTML to prevent XSS
            const escapedFilename = escapeHtml(backup.filename);
            const escapedSize = escapeHtml(backup.size_mb);
            const escapedDate = escapeHtml(backup.modified);
            
            html += '<tr style="border-bottom: 1px solid #ccc;">';
            html += '<td style="padding: 8px;">' + escapedFilename + '</td>';
            html += '<td style="padding: 8px; text-align: center;">' + escapedSize + '</td>';
            html += '<td style="padding: 8px; text-align: center;">' + escapedDate + '</td>';
            html += '<td style="padding: 8px; text-align: center;">';
            html += '<button type="button" class="btn-primary restore-btn" data-filename="' + escapedFilename + '" style="font-size: 14px; padding: 5px 15px;">Restore</button>';
            html += '</td>';
            html += '</tr>';
          });
          
          html += '</table>';
          container.innerHTML = html;
          
          // Add event listeners to restore buttons using event delegation
          document.querySelectorAll('.restore-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const filename = this.getAttribute('data-filename');
              restoreBackup(filename);
            });
          });
        } else if (data.success && data.backups.length === 0) {
          container.innerHTML = '<p style="font-style: italic; color: #666;">No backups found at ' + escapeHtml(data.path) + '</p>';
        } else {
          container.innerHTML = '<p style="color: red;">' + escapeHtml(data.message) + '</p>';
        }
      })
      .catch(error => {
        container.innerHTML = '<p style="color: red;">Error loading backups: ' + escapeHtml(error.message) + '</p>';
      });
    }
    
    function restoreBackup(filename) {
      if (!confirm('Are you sure you want to restore from this backup?\n\nThis will overwrite current files and requires an application restart.\n\nBackup: ' + filename)) {
        return;
      }
      
      const backupPath = document.getElementById('backup_path').value;
      const container = document.getElementById('backup-list-container');
      
      container.innerHTML = '<p style="font-style: italic; color: blue;">Restoring from backup, please wait...</p>';
      
      fetch('/restore_system', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'backup_path=' + encodeURIComponent(backupPath) + '&backup_filename=' + encodeURIComponent(filename)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          if (data.restart_required) {
            container.innerHTML = '<p style="color: green; font-weight: bold;">âœ“ Restore complete! Please restart the application.</p>';
          }
        } else {
          container.innerHTML = '<p style="color: red;">âœ— ' + data.message + '</p>';
        }
      })
      .catch(error => {
        container.innerHTML = '<p style="color: red;">âœ— Error: ' + escapeHtml(error.message) + '</p>';
      });
    }
    
    function updateSmtpSettings() {
      const email = document.getElementById('sending_email').value;
      const smtpHost = document.getElementById('smtp_host');
      const smtpPort = document.getElementById('smtp_port');
      
      if (!email) return;
      
      // Extract domain from email
      const domain = email.split('@')[1];
      if (!domain) return;
      
      // Auto-detect common SMTP settings
      const smtpSettings = {
        'gmail.com': { host: 'smtp.gmail.com', port: 587 },
        'outlook.com': { host: 'smtp-mail.outlook.com', port: 587 },
        'hotmail.com': { host: 'smtp-mail.outlook.com', port: 587 },
        'yahoo.com': { host: 'smtp.mail.yahoo.com', port: 587 },
        'icloud.com': { host: 'smtp.mail.me.com', port: 587 },
        'aol.com': { host: 'smtp.aol.com', port: 587 },
        'zoho.com': { host: 'smtp.zoho.com', port: 587 }
      };
      
      if (smtpSettings[domain]) {
        const currentHost = smtpHost.value.trim();
        const currentPort = smtpPort.value.trim();
        
        // List of known SMTP hosts - update if current value is empty or matches a known SMTP host
        const knownHosts = Object.values(smtpSettings).map(s => s.host);
        const shouldUpdateHost = !currentHost || knownHosts.includes(currentHost);
        
        // Update host if appropriate
        if (shouldUpdateHost) {
          smtpHost.value = smtpSettings[domain].host;
        }
        
        // Update port if it's empty or a common SMTP port (25, 465, 587)
        const commonPorts = ['25', '465', '587', ''];
        if (commonPorts.includes(currentPort)) {
          smtpPort.value = smtpSettings[domain].port;
        }
      }
    }

    // Test Email notification
    function testEmail() {
      const resultDiv = document.getElementById('test-result');
      resultDiv.innerHTML = '<span style="color: blue;">Sending test email...</span>';
      
      fetch('/test_email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = '<span style="color: green;">âœ“ ' + escapeHtml(data.message) + '</span>';
        } else {
          resultDiv.innerHTML = '<span style="color: red;">âœ— ' + escapeHtml(data.message) + '</span>';
        }
      })
      .catch(error => {
        resultDiv.innerHTML = '<span style="color: red;">âœ— Error: ' + escapeHtml(error.message) + '</span>';
      });
    }

    // Test Push notification
    function testPush() {
      const resultDiv = document.getElementById('test-result');
      resultDiv.innerHTML = '<span style="color: blue;">Sending test push notification...</span>';
      
      fetch('/test_push', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = '<span style="color: green;">âœ“ ' + escapeHtml(data.message) + '</span>';
        } else {
          resultDiv.innerHTML = '<span style="color: red;">âœ— ' + escapeHtml(data.message) + '</span>';
        }
      })
      .catch(error => {
        resultDiv.innerHTML = '<span style="color: red;">âœ— Error: ' + escapeHtml(error.message) + '</span>';
      });
    }

    // Test External Logging connection
    function testExternalConnection(index) {
      const resultDiv = document.getElementById('external-test-result-' + index);
      const urlField = document.getElementById('external_url_' + index);
      const url = urlField.value.trim();
      
      if (!url) {
        resultDiv.innerHTML = '<span style="color: orange;">âš  Please enter a URL before testing</span>';
        return;
      }
      
      // Get all configuration settings for this URL
      const method = document.getElementById('external_method_' + index)?.value || 'POST';
      const contentType = document.getElementById('external_content_type_' + index)?.value || 'form';
      const timeout = document.getElementById('external_timeout_seconds_' + index)?.value || 8;
      const fieldMapId = document.getElementById('external_field_map_id_' + index)?.value || 'default';
      const customFieldMap = document.getElementById('external_custom_field_map_' + index)?.value || '';
      
      resultDiv.innerHTML = '<span style="color: blue;">Testing connection...</span>';
      
      fetch('/test_external_logging', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ 
          index: index, 
          url: url,
          method: method,
          content_type: contentType,
          timeout_seconds: timeout,
          field_map_id: fieldMapId,
          custom_field_map: customFieldMap
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          resultDiv.innerHTML = '<span style="color: green;">âœ“ ' + escapeHtml(data.message) + '</span>';
        } else {
          resultDiv.innerHTML = '<span style="color: red;">âœ— ' + escapeHtml(data.message) + '</span>';
        }
      })
      .catch(error => {
        resultDiv.innerHTML = '<span style="color: red;">âœ— Error: ' + escapeHtml(error.message) + '</span>';
      });
    }
    
    // Test External Logging connection (legacy function - kept for backwards compatibility)
    function testExternalLogging(index) {
      // Redirect to new function
      testExternalConnection(index);
    }
    
    // Toggle Push provider fields
    function togglePushProvider() {
      const provider = document.getElementById('push_provider').value;
      const pushoverFields = document.querySelectorAll('.pushover-field');
      const ntfyFields = document.querySelectorAll('.ntfy-field');
      
      if (provider === 'pushover') {
        pushoverFields.forEach(field => field.style.display = '');
        ntfyFields.forEach(field => field.style.display = 'none');
      } else if (provider === 'ntfy') {
        pushoverFields.forEach(field => field.style.display = 'none');
        ntfyFields.forEach(field => field.style.display = '');
      }
    }
    
    // Initialize Push provider visibility on page load
    document.addEventListener('DOMContentLoaded', function() {
      togglePushProvider();
      
      // Activate the correct tab based on the server-provided active_tab value
      var activeTab = {{ active_tab | tojson }};
      if (activeTab && activeTab !== 'main-settings') {
        switchToTab(activeTab);
      }
    });
  </script>
</body>
</html>