<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Temperature Control - Configuration</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script>
    function confirmReset() {
      if (!confirm('Are you sure you want to RESET the historical log? This action will clear the log and create a timestamped backup.')) {
        return false;
      }
      // Submit the reset form
      document.getElementById('resetLogsForm').submit();
      return true;
    }

    function setCurrentTempToLive() {
      // copy the displayed live temp into the "current_temp" input if a live temp exists
      var live = document.getElementById('live_current_temp');
      var cur = document.getElementById('current_temp');
      if (live && cur && live.dataset.value) {
        cur.value = live.dataset.value;
      }
    }
  </script>

  <style>
    /* Minimal local rules so page isn't totally raw if styles.css fails */
    .page-container { font-family: Arial, Helvetica, sans-serif; padding: 0 12px; color: #222; }
    .site-header { margin: 18px 0; }
    .config-ribbon a { margin-right: 16px; color: #1a6; text-decoration: none; font-weight: bold; }
    .btn { padding: 6px 10px; border: 1px solid #888; background:#eee; border-radius:3px; text-decoration:none; color:#000; cursor: pointer; }
    .btn.secondary { background:#fff; color:#00f; border-color:#d0d0d0; }
    .btn.warning { background:#fdd; border-color:#f00; color:#700; }
    .form-row { margin: 8px 0; display:flex; align-items:center; }
    label { display:inline-block; min-width:160px; vertical-align: middle; }
    input[type=number], input[type=text], select { padding:6px; border:1px solid #ccc; border-radius:4px; width:240px; }
    .small { font-size:0.9em; color:#666; margin-left:8px; }
    .section { border:1px solid #eee; padding:12px; margin-bottom:12px; border-radius:6px; background:#fff; }
    table { border-collapse:collapse; }
    table td, table th { padding:8px; border-bottom:1px solid #f0f0f0; }
    h1,h2 { color:#1a6; }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="site-header">
      <nav class="config-ribbon" role="navigation" aria-label="top navigation">
        <a href="/">Dashboard</a>
        <a href="/system_config">System Settings</a>
        <a href="/temp_config">Temperature Control</a>
      </nav>
      <h1>Temperature Control Settings</h1>
    </header>

    <main style="max-width:1100px; margin: 12px auto;">
      <div class="section">
        <h2>Control Limits & Mode</h2>
        <form id="tempConfigForm" action="/update_temp_config" method="post">
          <!-- If you use CSRF tokens, render them here -->
          {% if csrf_token %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          {% endif %}

          <div class="form-row">
            <label for="tilt_color">Control Tilt (color):</label>
            <select id="tilt_color" name="tilt_color" title="Choose which Tilt sensor is used by the control loop">
              <option value="" {% if not temp_control.tilt_color %}selected{% endif %}>Auto — use first live Tilt</option>
              {% if report_colors %}
                <optgroup label="Configured Tilts">
                  {% for c in report_colors %}
                    <option value="{{ c }}" {% if temp_control.tilt_color == c %}selected{% endif %}>{{ c }}</option>
                  {% endfor %}
                </optgroup>
              {% endif %}
            </select>
            <span class="small">Select which Tilt's temperature is used for control (or Auto).</span>
          </div>

          <div class="form-row">
            <label for="low_limit">Low Limit (°F):</label>
            <input id="low_limit" name="low_limit" type="number" step="0.1" value="{{ temp_control.low_limit|default('') }}">
          </div>

          <div class="form-row">
            <label for="high_limit">High Limit (°F):</label>
            <input id="high_limit" name="high_limit" type="number" step="0.1" value="{{ temp_control.high_limit|default('') }}">
          </div>

          <div class="form-row">
            <label>Enabled Actions:</label>
            <div>
              <label style="display:inline-block; width:auto;"><input type="checkbox" name="enable_heating" {% if temp_control.enable_heating %}checked{% endif %}> Enable Heating</label>
              <label style="display:inline-block; width:auto; margin-left:12px;"><input type="checkbox" name="enable_cooling" {% if temp_control.enable_cooling %}checked{% endif %}> Enable Cooling</label>
            </div>
          </div>

          <div class="form-row">
            <label for="heating_plug">Heating Plug URL/ID:</label>
            <input id="heating_plug" name="heating_plug" type="text" value="{{ temp_control.heating_plug|default('') }}" placeholder="kasa device host or id">
          </div>

          <div class="form-row">
            <label for="cooling_plug">Cooling Plug URL/ID:</label>
            <input id="cooling_plug" name="cooling_plug" type="text" value="{{ temp_control.cooling_plug|default('') }}" placeholder="kasa device host or id">
          </div>

          <div class="form-row">
            <label for="current_temp">Override Current Temp:</label>
            <input id="current_temp" name="current_temp" type="text" value="{{ temp_control.current_temp|default('') }}" placeholder="leave blank to use live tilt">
            <button type="button" class="btn" onclick="setCurrentTempToLive()">Use Live</button>
            <span id="live_current_temp" data-value="{{ temp_control.current_temp if temp_control.current_temp is not none else '' }}" class="small" style="margin-left:8px;">
              Live: {% if temp_control.current_temp is not none %}{{ temp_control.current_temp }}°F{% else %}<em>no live temp</em>{% endif %}
            </span>
          </div>

          <div class="form-row">
            <label for="tilt_logging_interval_minutes">Tilt Log Interval (min):</label>
            <input id="tilt_logging_interval_minutes" name="tilt_logging_interval_minutes" type="number" min="1" step="1" value="{{ system_settings.tilt_logging_interval_minutes|default(15) }}">
            <span class="small">How often tilt_reading entries are appended (per color)</span>
          </div>

          <div class="form-row">
            <label for="warnings_mode">Notifications:</label>
            <select id="warnings_mode" name="warnings_mode">
              <option value="NONE" {% if temp_control.warnings_mode == 'NONE' %}selected{% endif %}>Disabled</option>
              <option value="EMAIL" {% if temp_control.warnings_mode == 'EMAIL' %}selected{% endif %}>Email</option>
              <option value="SMS" {% if temp_control.warnings_mode == 'SMS' %}selected{% endif %}>SMS</option>
              <option value="BOTH" {% if temp_control.warnings_mode == 'BOTH' %}selected{% endif %}>Email + SMS</option>
            </select>
            <span class="small">Configured contact details live in System Settings</span>
          </div>

          <div class="form-row" style="margin-top:12px;">
            <button type="submit" class="btn">Save Settings</button>
            <a class="btn secondary" href="/temp_report" style="margin-left:8px;">View Log</a>
            <a class="btn secondary" href="/export_temp_csv" style="margin-left:8px;">Export</a>
          </div>
        </form>
      </div>

      <div class="section">
        <h2>Runtime Status</h2>
        <div class="form-row"><label>Mode:</label> <strong>{{ temp_control.mode|default('Off') }}</strong></div>
        <div class="form-row"><label>Status:</label> <strong>{{ temp_control.status|default('Unknown') }}</strong></div>
        <div class="form-row"><label>Heater On:</label> <span>{{ 'Yes' if temp_control.heater_on else 'No' }}</span></div>
        <div class="form-row"><label>Cooler On:</label> <span>{{ 'Yes' if temp_control.cooler_on else 'No' }}</span></div>
        <div class="form-row"><label>Notifications:</label> <span>{{ temp_control.warnings_mode|default('NONE') }}</span></div>
        <div class="form-row"><label>Last Notification:</label> <span>{{ temp_control.notification_last_sent|default('never') }}</span></div>
      </div>

      <div class="section">
        <h2>Active Tilts</h2>
        {% if live_tilts %}
          <table style="width:100%;">
            <thead>
              <tr style="text-align:left;">
                <th>Color</th><th>Temp</th><th>Gravity</th><th>RSSI</th><th>Brew</th><th>Last Seen</th>
              </tr>
            </thead>
            <tbody>
              {% for color, info in live_tilts.items() %}
                <tr>
                  <td>{{ color }}</td>
                  <td>{% if info.temp_f is not none %}{{ info.temp_f }}°F{% else %}&mdash;{% endif %}</td>
                  <td>{% if info.gravity is not none %}{{ info.gravity }}{% else %}&mdash;{% endif %}</td>
                  <td>{{ info.rssi if info.rssi is not none else '&mdash;' }}</td>
                  <td>{{ info.batch_name or info.beer_name or '&mdash;' }}</td>
                  <td class="small">{{ info.timestamp }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="small">No live Tilt adverts seen yet.</p>
        {% endif %}
      </div>

      <div class="section">
        <h2>Logs & Maintenance</h2>
        <p class="small">You can archive or reset the historical temp log. Archiving moves tilt_reading entries into the <code>batches/</code> directory; resetting makes a timestamped backup and clears the main log.</p>

        <div style="margin-top:8px;">
          <form id="resetLogsForm" action="/reset_logs" method="post" style="display:inline;">
            <!-- historically this endpoint was used to reset; using a confirm prevents accidental clears -->
            <button type="button" class="btn warning" onclick="confirmReset()">Reset Logs (backup & clear)</button>
          </form>
          <a href="/temp_report" class="btn secondary" style="margin-left:8px;">View full temp log</a>
        </div>

        <div style="margin-top:12px;">
          <form action="/scan_kasa_plugs" method="get" style="display:inline;">
            <button type="submit" class="btn">Scan Kasa Plugs</button>
          </form>
          <span class="small" style="margin-left:8px;">Detect local Kasa smart plugs for heater/cooler control</span>
        </div>
      </div>

      <footer style="margin-top:20px; color:#666; font-size:0.9em;">
        <div>FermenterApp — Temperature control settings</div>
        <div class="small">If parts of this page look raw, clear your browser cache (Ctrl+F5) to ensure <code>/static/styles.css</code> is loaded.</div>
      </footer>
    </main>
  </div>
</body>
</html>