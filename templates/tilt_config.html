<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tilt Configuration</title>
  <link rel="stylesheet" href="/static/styles.css">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    .page { max-width: 980px; margin:20px auto; padding:18px; background:#fff; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .color-grid { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    .color-btn { padding:10px 14px; border-radius:8px; font-weight:800; text-decoration:none; color:#fff; border:2px solid #222; }
    .form-group { margin-bottom:12px; }
    label { display:block; font-weight:700; margin-bottom:6px; }
    input[type="text"], input[type="date"], input[type="number"] { width:100%; padding:8px; border:1px solid #ddd; border-radius:6px; }
    .actions { display:flex; gap:8px; margin-top:10px; }
    .note { color:#666; font-size:0.95em; }
  </style>
</head>
<body>
  <div class="page-container">
    <header class="site-header">
      <nav class="config-ribbon">
        <a href="/">Dashboard</a>
        <a href="/system_config">System Settings</a>
        <a href="/temp_config">Temperature Control</a>
      </nav>
      <h1 class="dashboard-title">Tilt Configuration</h1>
    </header>

    <main class="page" role="main">
      <div class="header">
        <div>
          <div style="font-weight:900;">Select a Tilt Color to Edit</div>
          <div class="note">Active tilts are shown below; choose one to configure or create a new batch.</div>
        </div>
        <div>
          <a href="/batch_settings" style="text-decoration:none; padding:8px 12px; background:#0b8a2e; color:#fff; border-radius:6px;">Batch Settings</a>
        </div>
      </div>

      <div class="color-grid" aria-label="Tilt Colors">
        {% for color in tilt_colors %}
          <form method="get" action="/tilt_config" style="display:inline;">
            <input type="hidden" name="tilt_color" value="{{ color }}">
            <button type="submit"
              class="color-btn"
              style="background-color: {{ COLOR_MAP.get(color, '#333') }}; color: {% if COLOR_MAP.get(color,'#333') in ['#ffff00','#ffc0cb','#00ff00'] %}black{% else %}white{% endif %};">
              {{ color }}
            </button>
          </form>
        {% endfor %}
      </div>

      {% if selected_tilt %}
        <section aria-label="Editing tilt">
          <h2 style="margin-top:0;">Editing: {{ selected_tilt }}</h2>

          <div style="margin-bottom:12px;">
            <strong>Current configured batch:</strong>
            {% if selected_config and selected_config.beer_name %}
              <div>{{ selected_config.beer_name }} — {{ selected_config.batch_name }} ({{ selected_config.ferm_start_date }})</div>
            {% else %}
              <div class="note">No batch configured for this tilt.</div>
            {% endif %}
          </div>

          <!-- Quick-edit small form to update Actual OG and confirmation -->
          <div style="padding:12px; background:#f6f9f6; border-radius:8px; margin-bottom:12px;">
            <form method="post" action="/batch_settings">
              <input type="hidden" name="tilt_color" value="{{ selected_tilt }}">
              <div class="form-group">
                <label>Measured Original Gravity (Actual OG)</label>
                <input type="text" name="actual_og" value="{{ selected_config.actual_og if selected_config.actual_og is not none else '' }}" placeholder="e.g. 1.055">
              </div>
              <div class="form-group">
                <label><input type="checkbox" name="og_confirmed" value="1" {% if selected_config.og_confirmed %}checked{% endif %}> I confirm this OG measurement is correct</label>
              </div>

              <!-- Keep minimal recipe fields available here too -->
              <div class="form-group">
                <label>Recipe Original Gravity (optional)</label>
                <input type="text" name="recipe_og" value="{{ selected_config.recipe_og or '' }}" placeholder="e.g. 1.055">
              </div>

              <div class="actions">
                <button type="submit" class="btn-primary">Save OG / Quick Save</button>
                <a href="/batch_settings?tilt_color={{ selected_tilt }}" style="display:inline-flex; align-items:center; padding:8px 10px; border-radius:6px; background:#007bff; color:#fff; text-decoration:none;">Full Batch Edit</a>
                <a href="/" style="align-self:center; margin-left:8px; text-decoration:none;">Return</a>
              </div>
            </form>
          </div>

          <!-- Provide a full batch-edit entry pathway (redirect to batch_settings) -->
          <div style="padding:12px; background:#fff8f8; border-radius:8px;">
            <div style="font-weight:800; margin-bottom:8px;">Start a new batch or edit full batch details</div>
            <form method="post" action="/tilt_config">
              <input type="hidden" name="tilt_color" value="{{ selected_tilt }}">
              <input type="hidden" name="action" value="new_batch">
              <div class="form-group">
                <label>New Beer Name</label>
                <input type="text" name="beer_name" value="">
              </div>
              <div class="form-group">
                <label>New Batch Name</label>
                <input type="text" name="batch_name" value="">
              </div>
              <div class="form-group">
                <label>Fermentation Start Date</label>
                <input type="date" name="ferm_start_date" value="">
              </div>
              <div class="actions">
                <button type="submit" class="btn-primary">Create New Batch (go to Batch Settings)</button>
                <a href="/tilt_config" style="align-self:center; margin-left:8px; text-decoration:none;">Cancel</a>
              </div>
            </form>
          </div>

          {% if batch_history %}
            <div style="margin-top:16px;">
              <h3>Batch History</h3>
              <ul>
                {% for b in batch_history %}
                  <li>
                    {{ b.ferm_start_date or '--' }} — {{ b.beer_name or '--' }} / {{ b.batch_name or '--' }}
                    {% if b.recipe_og %}(Recipe OG: {{ b.recipe_og }}){% elif b.actual_og %}(Measured OG: {{ b.actual_og }}){% endif %}
                    {% if b.og_confirmed %} — (OG Confirmed){% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        </section>
      {% else %}
        <div class="note">Pick a color above to configure that Tilt (or use Batch Settings to edit batches).</div>
      {% endif %}
    </main>
  </div>
</body>
</html>