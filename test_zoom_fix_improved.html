<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Test Zoom Fix - Improved</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/plotly.js-dist-min"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 16px; background: #f6f6f6; }
    #chart-container { max-width: 1200px; margin: auto; background: #ffffff; border-radius: 4px; padding: 16px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
    #tempChart { height: 500px; }
    .zoom-controls { text-align: center; margin: 12px 0; }
    .zoom-controls button { padding: 6px 16px; margin: 0 4px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .zoom-controls button:hover { background-color: #0b7dda; }
    .zoom-controls button.active { background-color: #0d47a1; }
    .info { text-align: center; margin: 16px 0; padding: 12px; background: #e8f4f8; border-radius: 4px; font-size: 14px; }
    .debug { text-align: left; margin: 16px 0; padding: 12px; background: #fff3cd; border-radius: 4px; font-size: 12px; font-family: monospace; }
  </style>
</head>
<body>
  <h2 style="text-align: center;">Test Zoom Fix - Fixed Implementation</h2>
  <div class="info">
    <strong>Testing fixed zoom behavior:</strong><br>
    This uses currentXRange to track state instead of reading from Plotly's chart.layout.xaxis.range<br>
    Click buttons and watch the debug output
  </div>
  <div class="debug" id="debug">Debug info will appear here</div>
  <div class="zoom-controls">
    <button id="zoom-in">Zoom In</button>
    <button id="zoom-out">Zoom Out</button>
    <button id="reset-zoom">Reset Zoom</button>
    <span style="margin: 0 12px;">|</span>
    <button id="view-1day">1 Day</button>
    <button id="view-1week">1 Week</button>
    <button id="view-all" class="active">All Data</button>
  </div>
  <div id="chart-container">
    <div id="tempChart"></div>
  </div>

  <script>
    // Create sample data - 10 days of temperature data
    const now = new Date();
    const baseTime = new Date(now.getTime() - 10 * 24 * 60 * 60 * 1000); // 10 days ago
    
    const dataPoints = [];
    for (let i = 0; i < 480; i++) {
      const timestamp = new Date(baseTime.getTime() + i * 30 * 60 * 1000);
      let temp = 66 + 2 * Math.sin(i / 20) + (Math.random() - 0.5);
      dataPoints.push({
        timestamp: timestamp,
        temp_f: temp,
      });
    }
    
    // Create temperature trace
    const traces = [{
      type: 'scatter',
      x: dataPoints.map(p => p.timestamp),
      y: dataPoints.map(p => p.temp_f),
      mode: 'lines',
      name: 'Temperature',
      line: { color: 'blue', width: 1.5 },
    }];
    
    // Calculate default range
    const xAxisRange = [dataPoints[0].timestamp, dataPoints[dataPoints.length - 1].timestamp];
    
    // Layout
    const layout = {
      title: 'Temperature Control Test - Fixed Implementation',
      xaxis: {
        title: 'Timestamp',
        range: xAxisRange,
        autorange: false,
      },
      yaxis: {
        title: 'Temperature (°F)',
        range: [62, 70],
      },
      showlegend: true,
      margin: { l: 50, r: 50, t: 70, b: 80 },
    };
    
    Plotly.newPlot('tempChart', traces, layout);
    
    // Constants
    const MS_PER_DAY = 24 * 60 * 60 * 1000;
    const MS_PER_WEEK = 7 * 24 * 60 * 60 * 1000;
    
    // Store ranges - FIXED: Track currentXRange ourselves instead of reading from Plotly
    let defaultXRange = xAxisRange;
    let currentXRange = xAxisRange;
    let currentViewMode = 'all';
    
    function updateDebug(message) {
      const debugEl = document.getElementById('debug');
      debugEl.innerHTML = message;
    }
    
    function updateViewButtonStates(activeMode) {
      const buttons = {
        'all': document.getElementById('view-all'),
        '1day': document.getElementById('view-1day'),
        '1week': document.getElementById('view-1week')
      };
      
      Object.keys(buttons).forEach(mode => {
        if (mode === activeMode) {
          buttons[mode].classList.add('active');
        } else {
          buttons[mode].classList.remove('active');
        }
      });
      
      currentViewMode = activeMode;
    }
    
    // FIXED IMPLEMENTATION - Use currentXRange instead of chart.layout.xaxis.range
    document.getElementById('zoom-in').addEventListener('click', () => {
      if (currentXRange && currentXRange.length === 2 && defaultXRange) {
        const start = new Date(currentXRange[0]);
        const end = new Date(currentXRange[1]);
        const duration = end - start;
        const newDuration = duration * 0.5;  // Zoom in by 50%
        
        // Center on the last data point (most recent data)
        const lastDataPoint = new Date(defaultXRange[1]);
        const newStart = new Date(lastDataPoint.getTime() - newDuration);
        const newEnd = lastDataPoint;
        
        // Update current range BEFORE calling relayout
        currentXRange = [newStart, newEnd];
        
        updateDebug(`<strong>ZOOM IN - FIXED</strong><br>
          Previous range: ${start.toLocaleString()} to ${end.toLocaleString()}<br>
          Previous duration: ${(duration / (24 * 60 * 60 * 1000)).toFixed(2)} days<br>
          Last data point: ${lastDataPoint.toLocaleString()}<br>
          <strong>New range: ${newStart.toLocaleString()} to ${newEnd.toLocaleString()}</strong><br>
          New duration: ${(newDuration / (24 * 60 * 60 * 1000)).toFixed(2)} days<br>
          ✓ Using currentXRange (not reading from Plotly)<br>
          ✓ Centering on LAST DATA POINT`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': [newStart, newEnd]
        });
      }
    });
    
    document.getElementById('zoom-out').addEventListener('click', () => {
      if (currentXRange && currentXRange.length === 2 && defaultXRange) {
        const start = new Date(currentXRange[0]);
        const end = new Date(currentXRange[1]);
        const duration = end - start;
        const newDuration = duration * 2;  // Zoom out by 100%
        
        // Center on the last data point (most recent data)
        const lastDataPoint = new Date(defaultXRange[1]);
        let newStart = new Date(lastDataPoint.getTime() - newDuration);
        let newEnd = lastDataPoint;
        
        // Don't zoom out beyond the default range
        const defaultStart = new Date(defaultXRange[0]);
        const defaultEnd = new Date(defaultXRange[1]);
        if (newStart < defaultStart) {
          newStart = defaultStart;
          if (newEnd > defaultEnd) newEnd = defaultEnd;
        }
        
        // Update current range BEFORE calling relayout
        currentXRange = [newStart, newEnd];
        
        updateDebug(`<strong>ZOOM OUT - FIXED</strong><br>
          Previous range: ${start.toLocaleString()} to ${end.toLocaleString()}<br>
          Previous duration: ${(duration / (24 * 60 * 60 * 1000)).toFixed(2)} days<br>
          Last data point: ${lastDataPoint.toLocaleString()}<br>
          <strong>New range: ${newStart.toLocaleString()} to ${newEnd.toLocaleString()}</strong><br>
          New duration: ${((newEnd - newStart) / (24 * 60 * 60 * 1000)).toFixed(2)} days<br>
          ✓ Using currentXRange (not reading from Plotly)<br>
          ✓ Centering on LAST DATA POINT<br>
          ✓ Constrained to default range`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': [newStart, newEnd]
        });
      }
    });
    
    document.getElementById('reset-zoom').addEventListener('click', () => {
      if (defaultXRange) {
        // Reset current range to default
        currentXRange = defaultXRange;
        
        updateDebug(`<strong>RESET ZOOM - FIXED</strong><br>
          Resetting to default: ${new Date(defaultXRange[0]).toLocaleString()} to ${new Date(defaultXRange[1]).toLocaleString()}<br>
          ✓ Restored currentXRange to defaultXRange`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': defaultXRange
        });
      }
      updateViewButtonStates(currentViewMode);
    });
    
    // 1 Day view
    document.getElementById('view-1day').addEventListener('click', () => {
      if (defaultXRange && defaultXRange.length === 2) {
        const end = new Date(defaultXRange[1]);
        let start = new Date(end.getTime() - MS_PER_DAY);
        
        const defaultStart = new Date(defaultXRange[0]);
        if (start < defaultStart) start.setTime(defaultStart.getTime());
        
        // Update current range
        currentXRange = [start, end];
        
        updateDebug(`<strong>1 DAY VIEW</strong><br>
          Showing last 24 hours<br>
          Range: ${start.toLocaleString()} to ${end.toLocaleString()}`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': [start, end]
        });
        updateViewButtonStates('1day');
      }
    });
    
    // 1 Week view
    document.getElementById('view-1week').addEventListener('click', () => {
      if (defaultXRange && defaultXRange.length === 2) {
        const end = new Date(defaultXRange[1]);
        let start = new Date(end.getTime() - MS_PER_WEEK);
        
        const defaultStart = new Date(defaultXRange[0]);
        if (start < defaultStart) start.setTime(defaultStart.getTime());
        
        // Update current range
        currentXRange = [start, end];
        
        updateDebug(`<strong>1 WEEK VIEW</strong><br>
          Showing last 7 days<br>
          Range: ${start.toLocaleString()} to ${end.toLocaleString()}`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': [start, end]
        });
        updateViewButtonStates('1week');
      }
    });
    
    // All data view
    document.getElementById('view-all').addEventListener('click', () => {
      if (defaultXRange) {
        // Reset current range to default
        currentXRange = defaultXRange;
        
        updateDebug(`<strong>ALL DATA VIEW</strong><br>
          Showing complete data range<br>
          Range: ${new Date(defaultXRange[0]).toLocaleString()} to ${new Date(defaultXRange[1]).toLocaleString()}`);
        
        Plotly.relayout('tempChart', {
          'xaxis.range': defaultXRange
        });
        updateViewButtonStates('all');
      }
    });
  </script>
</body>
</html>
